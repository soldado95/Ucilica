<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uƒçimo Zajedno! üåà</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;800&display=swap');

  :root {
    --bg: #0D0A2A;
    --card: #16103A;
    --card2: #1F1850;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    min-height: 100vh;
    color: white;
    overflow-x: hidden;
  }

  body::before {
    content:'';
    position:fixed;
    inset:0;
    background:
      radial-gradient(ellipse at 20% 30%, rgba(168,85,247,.15) 0%, transparent 55%),
      radial-gradient(ellipse at 80% 70%, rgba(59,130,246,.12) 0%, transparent 55%);
    pointer-events:none;
    z-index:0;
  }

  .screen { display:none; position:relative; z-index:1; }
  .screen.active { display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px 16px 40px; }

  /* ======= HOME ======= */
  .logo {
    font-family:'Fredoka One',cursive;
    font-size: clamp(2.8rem, 9vw, 5rem);
    background: linear-gradient(135deg,#FF6B9D,#A855F7,#3B82F6);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    text-align:center;
    margin-top:30px;
    filter:drop-shadow(0 0 30px rgba(168,85,247,.5));
    animation:float 3s ease-in-out infinite;
  }
  @keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

  .subtitle { font-size:1rem; color:rgba(255,255,255,.5); margin:8px 0 44px; letter-spacing:3px; text-transform:uppercase; }

  .game-cards { display:flex; gap:20px; flex-wrap:wrap; justify-content:center; width:100%; max-width:860px; }

  .game-card {
    background:var(--card);
    border-radius:28px;
    padding:34px 24px;
    width:250px;
    cursor:pointer;
    border:2px solid transparent;
    transition:all .3s cubic-bezier(.34,1.56,.64,1);
  }
  .game-card:hover { transform:translateY(-8px) scale(1.03); }
  .gc-boje  { border-color:rgba(255,107,157,.25); }
  .gc-slova { border-color:rgba(168,85,247,.25); }
  .gc-broji { border-color:rgba(16,185,129,.25); }
  .gc-boje:hover  { border-color:#FF6B9D; box-shadow:0 20px 50px rgba(255,107,157,.3); }
  .gc-slova:hover { border-color:#A855F7; box-shadow:0 20px 50px rgba(168,85,247,.3); }
  .gc-broji:hover { border-color:#10B981; box-shadow:0 20px 50px rgba(16,185,129,.3); }
  .gc-memorij { border-color:rgba(251,191,36,.25); }
  .gc-memorij:hover { border-color:#FBBF24; box-shadow:0 20px 50px rgba(251,191,36,.3); }
  .gc-puzli { border-color:rgba(6,182,212,.25); }
  .gc-puzli:hover { border-color:#06B6D4; box-shadow:0 20px 50px rgba(6,182,212,.3); }
  .gc-umetaljka { border-color:rgba(16,185,129,.25); }
  .gc-umetaljka:hover { border-color:#10B981; box-shadow:0 20px 50px rgba(16,185,129,.3); }
  .gc-govor { border-color:rgba(236,72,153,.25); }
  .gc-govor:hover { border-color:#EC4899; box-shadow:0 20px 50px rgba(236,72,153,.3); }

  /* ======= PUZZLE ======= */
  .puz-screen { width:100%; max-width:680px; display:flex; flex-direction:column; align-items:center; gap:16px; }
  .puz-top-label { font-family:'Fredoka One',cursive; font-size:1.1rem; color:rgba(255,255,255,.5); letter-spacing:1px; }

  /* Preview (small) */
  .puz-preview-wrap { position:relative; }
  .puz-preview {
    border-radius:14px; border:3px solid rgba(255,255,255,.2);
    box-shadow:0 4px 24px rgba(0,0,0,.4);
    display:block;
  }
  .puz-preview-label {
    position:absolute; bottom:-22px; left:50%; transform:translateX(-50%);
    font-size:.78rem; color:rgba(255,255,255,.4); white-space:nowrap;
  }

  /* Board where pieces go */
  .puz-board {
    display:grid;
    border-radius:16px;
    overflow:hidden;
    border:3px solid rgba(255,255,255,.15);
    box-shadow:0 8px 40px rgba(0,0,0,.5);
    position:relative;
  }
  .puz-slot {
    background:rgba(255,255,255,.05);
    border:2px dashed rgba(255,255,255,.15);
    position:relative;
    transition:background .2s, border-color .2s;
    display:flex; align-items:center; justify-content:center;
    cursor:default;
  }
  .puz-slot.over { background:rgba(6,182,212,.15); border-color:#06B6D4; }
  .puz-slot.filled { border:none; }
  .puz-slot.correct-flash { animation:correctFlash .4s ease; }
  @keyframes correctFlash{ 0%{filter:brightness(2)} 100%{filter:brightness(1)} }

  /* Piece tray */
  .puz-tray {
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center;
    padding:14px; background:rgba(255,255,255,.05);
    border-radius:20px; border:2px solid rgba(255,255,255,.08);
    width:100%;
  }
  .puz-piece {
    border-radius:10px;
    cursor:grab;
    border:3px solid rgba(255,255,255,.25);
    box-shadow:0 4px 16px rgba(0,0,0,.4);
    transition:transform .2s, box-shadow .2s;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
    touch-action:none;
    position:relative;
  }
  .puz-piece:hover { transform:scale(1.06) translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,.5); }
  .puz-piece:active { cursor:grabbing; transform:scale(1.1); }
  .puz-piece.dragging-pc { opacity:.35; }

  .puz-done-banner {
    font-family:'Fredoka One',cursive; font-size:2rem;
    background:linear-gradient(135deg,#06B6D4,#A855F7);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    animation:popIn .5s cubic-bezier(.34,1.56,.64,1);
    display:none;
  }

  .card-emoji { font-size:3rem; display:block; margin-bottom:14px; }
  .card-title { font-family:'Fredoka One',cursive; font-size:1.9rem; margin-bottom:8px; }
  .card-desc { font-size:.88rem; color:rgba(255,255,255,.45); line-height:1.5; }
  .card-dots { margin-top:16px; display:flex; gap:5px; flex-wrap:wrap; }
  .dot { width:11px; height:11px; border-radius:50%; background:rgba(255,255,255,.15); transition:background .3s; }
  .dot.done { background:#10B981; }

  /* ======= LEVEL SELECT ======= */
  .back-btn {
    align-self:flex-start;
    background:rgba(255,255,255,.1); border:none; color:white;
    padding:10px 20px; border-radius:50px; cursor:pointer;
    font-family:'Nunito',sans-serif; font-size:1rem; font-weight:700; transition:all .2s;
  }
  .back-btn:hover { background:rgba(255,255,255,.2); transform:translateX(-4px); }

  .screen-title { font-family:'Fredoka One',cursive; font-size:clamp(1.8rem,5vw,2.8rem); margin:28px 0 10px; text-align:center; }

  .level-grid {
    display:grid; grid-template-columns:repeat(5,1fr);
    gap:14px; max-width:560px; width:100%; margin-top:36px;
  }

  .lvl-btn {
    background:var(--card); border:2px solid rgba(255,255,255,.1); border-radius:18px;
    padding:18px 8px; cursor:pointer; color:white;
    font-family:'Fredoka One',cursive; font-size:1.3rem;
    transition:all .3s cubic-bezier(.34,1.56,.64,1);
    display:flex; flex-direction:column; align-items:center; gap:5px;
  }
  .lvl-btn:hover:not(.locked) { transform:scale(1.1); }
  .lvl-btn.locked { opacity:.35; cursor:not-allowed; }
  .lvl-btn.done { border-color:#10B981; }
  .lvl-num { font-size:.72rem; opacity:.55; font-family:'Nunito',sans-serif; }

  /* ======= GAME ======= */
  .game-top {
    display:flex; align-items:center; justify-content:space-between;
    width:100%; max-width:680px; margin-bottom:18px;
  }
  .prog-wrap { flex:1; height:13px; background:rgba(255,255,255,.1); border-radius:10px; overflow:hidden; margin:0 14px; }
  .prog-bar { height:100%; border-radius:10px; transition:width .5s ease; background:linear-gradient(90deg,#06B6D4,#A855F7); }
  .score-badge { background:rgba(255,255,255,.1); border-radius:50px; padding:6px 16px; font-weight:800; font-size:1.05rem; }
  .round-lbl { font-size:.82rem; color:rgba(255,255,255,.4); margin-top:2px; text-align:right; }

  /* COLOR CIRCLE */
  .color-stage {
    display:flex; flex-direction:column; align-items:center; gap:14px;
    margin-bottom:16px;
  }
  .color-circle {
    width:clamp(110px,22vw,160px);
    height:clamp(110px,22vw,160px);
    border-radius:50%;
    border:5px solid rgba(255,255,255,.3);
    cursor:pointer;
    position:relative;
    transition:transform .2s;
    animation:pulseShadow 2.5s ease-in-out infinite;
  }
  .color-circle:active { transform:scale(.94); }
  @keyframes pulseShadow{
    0%,100%{ box-shadow:0 0 40px var(--cc,#fff4), 0 0 80px var(--cc,#fff2); }
    50%{ box-shadow:0 0 80px var(--cc,#fff8), 0 0 160px var(--cc,#fff4); }
  }
  .sound-row { display:flex; align-items:center; gap:8px; }
  .speak-hint { font-size:.85rem; color:rgba(255,255,255,.45); animation:blink 2s ease-in-out infinite; }
  @keyframes blink{ 0%,100%{opacity:.45} 50%{opacity:.9} }
  .sound-wave { display:none; align-items:center; gap:3px; height:22px; }
  .sound-wave.on { display:flex; }
  .bar { width:4px; border-radius:4px; background:#A855F7; animation:wv .6s ease-in-out infinite; }
  .bar:nth-child(1){ height:8px; animation-delay:0s; }
  .bar:nth-child(2){ height:16px; animation-delay:.1s; }
  .bar:nth-child(3){ height:22px; animation-delay:.2s; }
  .bar:nth-child(4){ height:14px; animation-delay:.3s; }
  .bar:nth-child(5){ height:8px; animation-delay:.4s; }
  @keyframes wv{ 0%,100%{transform:scaleY(.4)} 50%{transform:scaleY(1)} }

  /* QUESTION */
  .q-label { font-size:.82rem; text-transform:uppercase; letter-spacing:2px; color:rgba(255,255,255,.4); margin-bottom:6px; text-align:center; }
  .q-text { font-family:'Fredoka One',cursive; font-size:clamp(1.3rem,4vw,2rem); text-align:center; margin-bottom:18px; min-height:50px; }

  /* ITEMS GRID */
  .items-grid {
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:12px; width:100%; max-width:500px;
  }

  .click-item {
    background:var(--card2); border:3px solid rgba(255,255,255,.12); border-radius:20px;
    padding:16px 8px; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; gap:7px;
    font-weight:700; transition:all .22s cubic-bezier(.34,1.56,.64,1);
    -webkit-tap-highlight-color:transparent; position:relative; overflow:hidden;
    user-select:none;
  }
  .click-item:hover { transform:scale(1.06); border-color:rgba(255,255,255,.3); }
  .click-item:active { transform:scale(.95); }
  .ci-emoji { font-size:2.5rem; line-height:1; }
  .ci-name { font-size:.8rem; opacity:.6; }

  .click-item.c-correct { border-color:#10B981; background:rgba(16,185,129,.2); animation:pop .35s ease; }
  .click-item.c-wrong   { border-color:#EF4444; background:rgba(239,68,68,.15); animation:shake .35s ease; }
  .click-item.c-reveal  { border-color:#10B981; background:rgba(16,185,129,.08); }
  .click-item.c-disabled{ pointer-events:none; }

  @keyframes pop  { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 30%{transform:translateX(-8px)} 70%{transform:translateX(8px)} }

  .ck { position:absolute; top:5px; right:8px; font-size:.85rem; }

  /* FEEDBACK + CONTINUE */
  .feedback-bar {
    border-radius:16px; padding:12px 22px; font-size:1rem; font-weight:700;
    text-align:center; min-height:50px;
    display:flex; align-items:center; justify-content:center; gap:8px;
    width:100%; max-width:500px; transition:all .3s; opacity:0;
  }
  .feedback-bar.show { opacity:1; }
  .feedback-bar.good { background:rgba(16,185,129,.2); border:2px solid rgba(16,185,129,.5); color:#6ee7b7; }
  .feedback-bar.bad  { background:rgba(239,68,68,.15); border:2px solid rgba(239,68,68,.4); color:#fca5a5; }

  .continue-btn {
    background:linear-gradient(135deg,#A855F7,#FF6B9D);
    border:none; color:white; padding:16px 44px; border-radius:50px;
    cursor:pointer; font-family:'Fredoka One',cursive; font-size:1.4rem;
    box-shadow:0 8px 30px rgba(168,85,247,.4); transition:all .2s;
    display:none; margin-top:8px;
    animation:popIn .4s cubic-bezier(.34,1.56,.64,1);
  }
  .continue-btn:hover { transform:scale(1.05); }
  @keyframes popIn{ from{transform:scale(.5);opacity:0} to{transform:scale(1);opacity:1} }

  /* ======= RESULT ======= */
  .result-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,.82);
    z-index:100; display:none; align-items:center; justify-content:center;
  }
  .result-overlay.show { display:flex; }
  .result-card {
    background:var(--card); border-radius:32px; padding:46px 54px; text-align:center;
    border:2px solid rgba(255,255,255,.1); max-width:420px; width:92%;
    animation:popIn .5s cubic-bezier(.34,1.56,.64,1);
  }
  .res-emoji { font-size:5rem; display:block; margin-bottom:14px; }
  .res-title { font-family:'Fredoka One',cursive; font-size:2.4rem; margin-bottom:6px; }
  .res-sub { color:rgba(255,255,255,.5); margin-bottom:26px; font-size:1.05rem; }
  .stars-row { display:flex; gap:8px; justify-content:center; font-size:2.2rem; margin-bottom:16px; }
  .btn-row { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  .btn-p { background:linear-gradient(135deg,#A855F7,#FF6B9D); border:none; color:white; padding:14px 36px; border-radius:50px; cursor:pointer; font-family:'Fredoka One',cursive; font-size:1.25rem; box-shadow:0 8px 28px rgba(168,85,247,.4); transition:all .2s; }
  .btn-p:hover { transform:scale(1.05); }
  .btn-s { background:rgba(255,255,255,.1); border:2px solid rgba(255,255,255,.2); color:white; padding:12px 32px; border-radius:50px; cursor:pointer; font-family:'Nunito',sans-serif; font-size:1rem; font-weight:700; transition:all .2s; }
  .btn-s:hover { background:rgba(255,255,255,.2); }


  /* ======= MEMORY GAME ======= */
  .mem-stats {
    display:flex; gap:20px; align-items:center; justify-content:center;
    margin-bottom:18px; flex-wrap:wrap;
  }
  .mem-stat {
    background:rgba(255,255,255,.08); border-radius:50px;
    padding:8px 20px; font-weight:800; font-size:1rem;
    display:flex; align-items:center; gap:6px;
  }
  .mem-grid {
    display:grid;
    gap:10px;
    width:100%; max-width:520px;
    margin:0 auto;
  }
  .mem-card-wrap {
    perspective:600px;
    cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }
  .mem-card {
    width:100%; padding-top:100%;
    position:relative;
    transform-style:preserve-3d;
    transition:transform 0.45s cubic-bezier(.4,0,.2,1);
    border-radius:18px;
  }
  .mem-card.flipped { transform:rotateY(180deg); }
  .mem-card.matched { transform:rotateY(180deg); }
  .mem-card-face {
    position:absolute; inset:0;
    border-radius:18px;
    display:flex; align-items:center; justify-content:center;
    backface-visibility:hidden;
    -webkit-backface-visibility:hidden;
  }
  .mem-card-back {
    background:linear-gradient(135deg,#2d1b69,#1a1040);
    border:2px solid rgba(255,255,255,.12);
    font-size:2rem;
    overflow:hidden;
  }
  .mem-card-back::before {
    content:'';
    position:absolute; inset:0;
    background:repeating-linear-gradient(
      45deg, transparent, transparent 8px,
      rgba(255,255,255,.03) 8px, rgba(255,255,255,.03) 16px
    );
  }
  .mem-card-front {
    background:linear-gradient(135deg,var(--card2),#2a1f6e);
    border:2px solid rgba(255,255,255,.18);
    font-size:2.4rem;
    transform:rotateY(180deg);
  }
  .mem-card.matched .mem-card-front {
    border-color:#10B981;
    background:linear-gradient(135deg,rgba(16,185,129,.25),rgba(16,185,129,.1));
    animation:matchPop .4s ease;
  }
  @keyframes matchPop{ 0%{transform:rotateY(180deg) scale(1)} 50%{transform:rotateY(180deg) scale(1.18)} 100%{transform:rotateY(180deg) scale(1)} }
  .mem-card-wrap:hover .mem-card:not(.flipped):not(.matched) {
    transform:rotateY(12deg) scale(1.05);
  }
  .mem-pairs-info {
    font-family:'Fredoka One',cursive;
    font-size:1rem; color:rgba(255,255,255,.45);
    margin-bottom:10px; text-align:center;
  }


  /* ======= UMETALJKA ======= */
  #screen-umetaljka {
    padding:0 !important;
    align-items:center;
  }
  /* Scene canvas */
  #umet-scene-canvas {
    display:block;
    width:100%;
    max-width:100%;
    touch-action:none;
  }
  /* Piece tray */
  .umet-tray {
    width:100%;
    display:flex; gap:14px; justify-content:center; align-items:center;
    padding:12px 16px 18px;
    background:rgba(8,4,28,.97);
    border-top:2px solid rgba(255,255,255,.08);
    flex-wrap:wrap;
    min-height:100px;
  }
  .umet-piece {
    cursor:grab;
    border-radius:18px;
    box-shadow:0 6px 20px rgba(0,0,0,.45);
    transition:transform .18s, box-shadow .18s;
    user-select:none;
    -webkit-tap-highlight-color:transparent;
    touch-action:none;
    animation:pieceFloat 3s ease-in-out infinite;
    border:3px solid rgba(255,255,255,.25);
  }
  .umet-piece:nth-child(2){animation-delay:.5s;}
  .umet-piece:nth-child(3){animation-delay:1s;}
  .umet-piece:nth-child(4){animation-delay:1.5s;}
  @keyframes pieceFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .umet-piece:hover{transform:scale(1.12) translateY(-5px);box-shadow:0 14px 32px rgba(0,0,0,.5);}
  .umet-piece.dragging-piece{opacity:.25;animation:none;transform:scale(.95);}

  /* Top bar overlay */
  #screen-umetaljka .game-top {
    position:relative; z-index:10;
    width:100%; max-width:100%;
    margin-bottom:0;
  }

  /* Task label */
  .umet-task-label {
    font-family:'Fredoka One',cursive;
    font-size:1rem; color:rgba(255,255,255,.7);
    padding:4px 0 8px;
    text-align:center;
    width:100%;
  }

  /* Slot glow on hover */
  .slot-over-glow {
    filter: drop-shadow(0 0 12px #10B981) drop-shadow(0 0 24px #10B981);
  }


  /* ======= GOVORIMO ======= */
  .govor-screen {
    width:100%; max-width:520px;
    display:flex; flex-direction:column; align-items:center;
    gap:0; padding:0 16px;
  }

  /* Big word card */
  .govor-card {
    width:100%;
    background:var(--card);
    border-radius:32px;
    border:2px solid rgba(255,255,255,.08);
    padding:28px 20px 24px;
    display:flex; flex-direction:column; align-items:center;
    gap:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
    position:relative;
    overflow:hidden;
  }
  .govor-card::before {
    content:'';
    position:absolute; inset:0;
    background:radial-gradient(ellipse at 30% 20%, rgba(236,72,153,.12), transparent 65%),
               radial-gradient(ellipse at 70% 80%, rgba(168,85,247,.1), transparent 65%);
    pointer-events:none;
  }

  /* Giant emoji */
  .govor-emoji {
    font-size:clamp(5rem,22vw,9rem);
    line-height:1;
    animation:emojiPop .5s cubic-bezier(.34,1.56,.64,1);
    filter:drop-shadow(0 8px 24px rgba(0,0,0,.4));
    cursor:pointer;
    transition:transform .15s;
    user-select:none;
  }
  .govor-emoji:active { transform:scale(.9); }
  @keyframes emojiPop {
    0%{transform:scale(0) rotate(-10deg);opacity:0}
    100%{transform:scale(1) rotate(0);opacity:1}
  }

  /* Word display */
  .govor-word {
    font-family:'Fredoka One',cursive;
    font-size:clamp(2.8rem,10vw,4.5rem);
    text-align:center;
    letter-spacing:2px;
    animation:wordSlide .4s ease;
  }
  @keyframes wordSlide{0%{opacity:0;transform:translateY(16px)}100%{opacity:1;transform:translateY(0)}}

  /* Syllable breakdown */
  .govor-syllables {
    font-family:'Fredoka One',cursive;
    font-size:clamp(1.1rem,4vw,1.5rem);
    color:rgba(255,255,255,.4);
    letter-spacing:4px;
    text-transform:uppercase;
  }

  /* Action buttons row */
  .govor-btns {
    display:flex; gap:14px; justify-content:center;
    width:100%; margin-top:20px;
  }
  .govor-btn {
    flex:1; max-width:160px;
    padding:18px 10px;
    border-radius:22px;
    border:none; cursor:pointer;
    font-family:'Fredoka One',cursive;
    font-size:1.2rem;
    display:flex; flex-direction:column; align-items:center; gap:6px;
    transition:transform .18s cubic-bezier(.34,1.56,.64,1), box-shadow .18s;
    -webkit-tap-highlight-color:transparent;
  }
  .govor-btn:active { transform:scale(.93); }
  .govor-btn-listen {
    background:linear-gradient(135deg,#3B82F6,#06B6D4);
    color:white; box-shadow:0 8px 24px rgba(59,130,246,.4);
  }
  .govor-btn-listen:hover { transform:scale(1.06); box-shadow:0 12px 32px rgba(59,130,246,.5); }
  .govor-btn-speak {
    background:linear-gradient(135deg,#EC4899,#A855F7);
    color:white; box-shadow:0 8px 24px rgba(236,72,153,.4);
  }
  .govor-btn-speak:hover { transform:scale(1.06); box-shadow:0 12px 32px rgba(236,72,153,.5); }
  .govor-btn-icon { font-size:1.8rem; }

  /* Nav arrows */
  .govor-nav {
    display:flex; align-items:center; gap:20px;
    margin-top:18px; width:100%; justify-content:center;
  }
  .govor-nav-btn {
    width:58px; height:58px;
    border-radius:50%; border:none; cursor:pointer;
    font-size:1.6rem;
    background:rgba(255,255,255,.08);
    color:white;
    transition:all .2s; display:flex; align-items:center; justify-content:center;
    -webkit-tap-highlight-color:transparent;
  }
  .govor-nav-btn:hover { background:rgba(255,255,255,.15); transform:scale(1.1); }
  .govor-nav-btn:disabled { opacity:.2; cursor:default; transform:none; }
  .govor-counter {
    font-family:'Fredoka One',cursive;
    font-size:1.3rem; color:rgba(255,255,255,.5);
    min-width:60px; text-align:center;
  }

  /* Category badge */
  .govor-category {
    font-size:.8rem; letter-spacing:2px; text-transform:uppercase;
    color:rgba(255,255,255,.35); font-weight:700;
    font-family:'Nunito',sans-serif;
    margin-top:4px;
  }

  /* Recording feedback */
  .govor-mic-pulse {
    width:70px; height:70px; border-radius:50%;
    background:linear-gradient(135deg,#EC4899,#A855F7);
    display:flex; align-items:center; justify-content:center;
    font-size:2rem;
    animation:micPulse .6s ease-in-out infinite alternate;
    box-shadow:0 0 0 0 rgba(236,72,153,.5);
  }
  @keyframes micPulse{
    0%{transform:scale(1);box-shadow:0 0 0 0 rgba(236,72,153,.5);}
    100%{transform:scale(1.1);box-shadow:0 0 0 16px rgba(236,72,153,0);}
  }

  .govor-listen-anim {
    display:flex; gap:4px; align-items:flex-end; height:40px;
  }
  .govor-bar {
    width:8px; border-radius:4px;
    background:linear-gradient(to top,#3B82F6,#06B6D4);
    animation:soundBar .5s ease-in-out infinite alternate;
  }
  .govor-bar:nth-child(1){height:20px;animation-delay:0s;}
  .govor-bar:nth-child(2){height:35px;animation-delay:.1s;}
  .govor-bar:nth-child(3){height:28px;animation-delay:.2s;}
  .govor-bar:nth-child(4){height:38px;animation-delay:.3s;}
  .govor-bar:nth-child(5){height:22px;animation-delay:.4s;}
  @keyframes soundBar{0%{transform:scaleY(.3)}100%{transform:scaleY(1)}}

  /* Stars completion */
  .govor-complete {
    text-align:center; padding:20px;
    animation:popIn .5s cubic-bezier(.34,1.56,.64,1);
  }

  /* CONFETTI */
  .cf { position:fixed; width:11px; height:11px; animation:cfFall linear forwards; z-index:200; pointer-events:none; }
  @keyframes cfFall{ 0%{transform:translateY(-20px) rotate(0);opacity:1} 100%{transform:translateY(106vh) rotate(720deg);opacity:0} }
</style>
</head>
<body>

<!-- HOME -->
<div class="screen active" id="screen-home">
  <div class="logo">üåà Uƒçimo!</div>
  <p class="subtitle">Odaberi igru</p>
  <div class="game-cards">
    <div class="game-card gc-boje" onclick="selectGame('boje')">
      <span class="card-emoji">üé®</span>
      <div class="card-title" style="background:linear-gradient(135deg,#FF6B9D,#FBBF24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Boje</div>
      <div class="card-desc">Klikni sve ≈°to je te boje!</div>
      <div class="card-dots" id="dots-boje"></div>
    </div>
    <div class="game-card gc-slova" onclick="selectGame('slova')">
      <span class="card-emoji">üî§</span>
      <div class="card-title" style="background:linear-gradient(135deg,#A855F7,#3B82F6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Slova</div>
      <div class="card-desc">Klikni sliku koja poƒçinje s tim slovom!</div>
      <div class="card-dots" id="dots-slova"></div>
    </div>
    <div class="game-card gc-broji" onclick="selectGame('broji')">
      <span class="card-emoji">üî¢</span>
      <div class="card-title" style="background:linear-gradient(135deg,#10B981,#06B6D4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Brojevi</div>
      <div class="card-desc">Klikni grupu s toƒçnim brojem!</div>
      <div class="card-dots" id="dots-broji"></div>
    </div>
    <div class="game-card gc-memorij" onclick="selectGame('memorij')">
      <span class="card-emoji">üß†</span>
      <div class="card-title" style="background:linear-gradient(135deg,#FBBF24,#F97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Memorij</div>
      <div class="card-desc">Pronaƒëi parove okretanjem kartica!</div>
      <div class="card-dots" id="dots-memorij"></div>
    </div>
    <div class="game-card gc-puzli" onclick="selectGame('puzli')">
      <span class="card-emoji">üß©</span>
      <div class="card-title" style="background:linear-gradient(135deg,#06B6D4,#3B82F6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Puzzle</div>
      <div class="card-desc">Slo≈æi komade slike na pravo mjesto!</div>
      <div class="card-dots" id="dots-puzli"></div>
    </div>
    <div class="game-card gc-umetaljka" onclick="selectGame('umetaljka')">
      <span class="card-emoji">üè†</span>
      <div class="card-title" style="background:linear-gradient(135deg,#10B981,#FBBF24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Umetaljka</div>
      <div class="card-desc">Ubaci broj, slovo ili oblik u pravu rupu!</div>
      <div class="card-dots" id="dots-umetaljka"></div>
    </div>
    <div class="game-card gc-govor" onclick="selectGame('govor')">
      <span class="card-emoji">üó£Ô∏è</span>
      <div class="card-title" style="background:linear-gradient(135deg,#EC4899,#F97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Govorimo!</div>
      <div class="card-desc">Nauƒçi prve rijeƒçi ‚Äî ƒçuj i ponovi!</div>
      <div class="card-dots" id="dots-govor"></div>
    </div>
  </div>
</div>

<!-- LEVEL SELECT -->
<div class="screen" id="screen-levels">
  <button class="back-btn" onclick="goHome()">‚Üê Natrag</button>
  <div class="screen-title" id="lvl-title">Odaberi level</div>
  <div class="level-grid" id="level-grid"></div>
</div>

<!-- GAME -->
<div class="screen" id="screen-game">
  <div class="game-top">
    <button class="back-btn" onclick="goLevels()" style="padding:8px 16px;font-size:.9rem;">‚Üê Natrag</button>
    <div class="prog-wrap"><div class="prog-bar" id="prog-bar"></div></div>
    <div>
      <div class="score-badge">‚≠ê <span id="score-val">0</span></div>
      <div class="round-lbl" id="round-lbl">1/5</div>
    </div>
  </div>

  <!-- Color stage (only for boje) -->
  <div class="color-stage" id="color-stage">
    <div class="color-circle" id="color-circle" onclick="speakColor()"></div>
    <div id="color-name-label" style="font-family:'Fredoka One',cursive;font-size:1.6rem;letter-spacing:1px;margin-top:4px;text-shadow:0 0 20px rgba(255,255,255,.3);"></div>
    <div class="sound-row">
      <span class="speak-hint" id="speak-hint">üîä Klikni za zvuk</span>
      <div class="sound-wave" id="sound-wave">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>
  </div>

  <div class="q-label" id="q-label"></div>
  <div class="q-text" id="q-text"></div>
  <div class="items-grid" id="items-grid"></div>
  <div class="feedback-bar" id="feedback-bar"></div>
  <button class="continue-btn" id="continue-btn" onclick="nextRound()">Dalje ‚Üí</button>
</div>

<!-- MEMORY GAME -->
<div class="screen" id="screen-memory">
  <div class="game-top">
    <button class="back-btn" onclick="goLevels()" style="padding:8px 16px;font-size:.9rem;">‚Üê Natrag</button>
    <div class="prog-wrap"><div class="prog-bar" id="mem-prog-bar"></div></div>
    <div>
      <div class="score-badge">‚≠ê <span id="mem-score-val">0</span></div>
      <div class="round-lbl" id="mem-moves-lbl">0 poteza</div>
    </div>
  </div>
  <div class="mem-pairs-info" id="mem-pairs-info">Pronaƒëi 2 para</div>
  <div class="mem-stats">
    <div class="mem-stat">üÉè <span id="mem-pairs-left">0</span> para ostalo</div>
    <div class="mem-stat">‚è±Ô∏è <span id="mem-timer">0</span>s</div>
  </div>
  <div class="mem-grid" id="mem-grid"></div>
</div>

<!-- PUZZLE GAME -->
<div class="screen" id="screen-puzzle">
  <div class="game-top">
    <button class="back-btn" onclick="goLevels()" style="padding:8px 16px;font-size:.9rem;">‚Üê Natrag</button>
    <div class="prog-wrap"><div class="prog-bar" id="puz-prog-bar"></div></div>
    <div>
      <div class="score-badge">üß© <span id="puz-level-lbl">Level 1</span></div>
    </div>
  </div>
  <div class="puz-screen">
    <div class="puz-done-banner" id="puz-done-banner">üéâ Bravo! Slo≈æio si puzzle!</div>
    <div class="puz-top-label" id="puz-top-label">Slo≈æi sliku!</div>
    <div class="puz-preview-wrap">
      <canvas id="puz-preview-canvas" class="puz-preview"></canvas>
      <span class="puz-preview-label">Ovako treba izgledati ‚Üí</span>
    </div>
    <div class="puz-board" id="puz-board"></div>
    <div class="puz-tray" id="puz-tray"></div>
  </div>
</div>

<!-- UMETALJKA -->
<div class="screen" id="screen-umetaljka">
  <div class="game-top">
    <button class="back-btn" onclick="goLevels()" style="padding:8px 16px;font-size:.9rem;position:relative;z-index:11;">‚Üê Natrag</button>
    <div class="prog-wrap"><div class="prog-bar" id="umet-prog-bar"></div></div>
    <div style="position:relative;z-index:11;">
      <div class="score-badge">üè† <span id="umet-level-lbl">Level 1</span></div>
    </div>
  </div>
  <div class="umet-task-label" id="umet-task-label">Ubaci broj!</div>
  <div style="position:relative;display:inline-block;line-height:0;">
    <canvas id="umet-scene-canvas" width="600" height="480"></canvas>
    <div id="umet-slots-layer" style="position:absolute;top:0;left:0;pointer-events:none;"></div>
  </div>
  <div class="umet-tray" id="umet-tray"></div>
</div>

<!-- GOVORIMO -->
<div class="screen" id="screen-govor">
  <div class="game-top">
    <button class="back-btn" onclick="goLevels()">‚Üê Natrag</button>
    <div class="prog-wrap"><div class="prog-bar" id="govor-prog-bar"></div></div>
    <div class="score-badge">üó£Ô∏è <span id="govor-lvl-lbl">1/20</span></div>
  </div>
  <div class="govor-screen">
    <div class="govor-card" id="govor-card">
      <div class="govor-category" id="govor-category">≈Ωivotinje</div>
      <div class="govor-emoji" id="govor-emoji" onclick="govorListen()">üê∂</div>
      <div class="govor-word" id="govor-word">PAS</div>
      <div class="govor-syllables" id="govor-syllables">P ¬∑ A ¬∑ S</div>
    </div>

    <div class="govor-btns">
      <button class="govor-btn govor-btn-listen" onclick="govorListen()" id="govor-listen-btn">
        <span class="govor-btn-icon">üîä</span>
        Slu≈°aj
      </button>
      <button class="govor-btn govor-btn-speak" id="govor-speak-btn"
        onmousedown="govorBtnDown(event)" onmouseup="govorBtnUp(event)" onmouseleave="govorBtnUp(event)"
        ontouchstart="govorBtnDown(event)" ontouchend="govorBtnUp(event)">
        <span class="govor-btn-icon">üé§</span>
        <span>Dr≈æi i govori</span>
      </button>
    </div>

    <div class="govor-nav">
      <button class="govor-nav-btn" id="govor-prev" onclick="govorNav(-1)">‚Üê</button>
      <div class="govor-counter" id="govor-counter">1 / 20</div>
      <button class="govor-nav-btn" id="govor-next" onclick="govorNav(1)">‚Üí</button>
    </div>
  </div>
</div>

<!-- RESULT -->
<div class="result-overlay" id="result-overlay">
  <div class="result-card">
    <span class="res-emoji" id="res-emoji">üéâ</span>
    <div class="stars-row" id="res-stars"></div>
    <div class="res-title" id="res-title">Bravo!</div>
    <div class="res-sub" id="res-sub"></div>
    <div class="btn-row">
      <button class="btn-s" onclick="retryLevel()">üîÑ Ponovi</button>
      <button class="btn-p" id="next-lvl-btn" onclick="nextLevel()">Sljedeƒái ‚Üí</button>
    </div>
  </div>
</div>

<script>
// ================================================================
// DATA
// ================================================================
// ================================================================
// LEVEL-BASED DATA: svaki level = 1 tema, 3 runde s 1/2/3 tocna odgovora
// ================================================================

// BOJE: 10 levela, svaki = jedna boja
// correct = sve sto je te boje (pool za runde), wrong = sto nije
const COLORS = [
  { color:'#EF4444', name:'Crvena',
    correct:[{e:'üçé',l:'Jabuka'},{e:'üåπ',l:'Ru≈æa'},{e:'üçì',l:'Jagoda'},{e:'‚ù§Ô∏è',l:'Srce'},{e:'üöí',l:'Vatrogasac'},{e:'üçÖ',l:'Rajƒçica'}],
    wrong:  [{e:'üê∏',l:'≈Ωaba'},{e:'üåä',l:'Val'},{e:'‚òÄÔ∏è',l:'Sunce'},{e:'üêß',l:'Pingvin'},{e:'üçá',l:'Gro≈æƒëe'},{e:'üêò',l:'Slon'},{e:'üåª',l:'Suncokret'},{e:'üê¨',l:'Delfin'}] },
  { color:'#3B82F6', name:'Plava',
    correct:[{e:'üåä',l:'Val'},{e:'üíô',l:'Srce'},{e:'ü´ê',l:'Borovnica'},{e:'üê¨',l:'Delfin'},{e:'üß¢',l:'Kapa'},{e:'ü¶ã',l:'Leptir'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåª',l:'Suncokret'},{e:'üê∏',l:'≈Ωaba'},{e:'üçä',l:'Naranƒça'},{e:'üåπ',l:'Ru≈æa'},{e:'ü¶Å',l:'Lav'},{e:'üêò',l:'Slon'},{e:'ü•ï',l:'Mrkva'}] },
  { color:'#22C55E', name:'Zelena',
    correct:[{e:'üê∏',l:'≈Ωaba'},{e:'üåø',l:'List'},{e:'üçÄ',l:'Djetelina'},{e:'üê¢',l:'Kornjaƒça'},{e:'ü•¶',l:'Brokula'},{e:'üå±',l:'Klica'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'‚òÅÔ∏è',l:'Oblak'},{e:'üåô',l:'Mjesec'},{e:'üêß',l:'Pingvin'},{e:'üçã',l:'Limun'},{e:'üêò',l:'Slon'},{e:'üåä',l:'Val'},{e:'ü¶Å',l:'Lav'}] },
  { color:'#FBBF24', name:'≈Ωuta',
    correct:[{e:'‚òÄÔ∏è',l:'Sunce'},{e:'üåª',l:'Suncokret'},{e:'üçã',l:'Limun'},{e:'üêù',l:'Pƒçela'},{e:'üåü',l:'Zvijezda'},{e:'üçå',l:'Banana'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåä',l:'Val'},{e:'üê∏',l:'≈Ωaba'},{e:'üçá',l:'Gro≈æƒëe'},{e:'üåπ',l:'Ru≈æa'},{e:'üêß',l:'Pingvin'},{e:'üêò',l:'Slon'},{e:'üê¨',l:'Delfin'}] },
  { color:'#F97316', name:'Naranƒçasta',
    correct:[{e:'üçä',l:'Naranƒça'},{e:'üéÉ',l:'Bundeva'},{e:'ü¶ä',l:'Lisica'},{e:'ü•ï',l:'Mrkva'},{e:'üçë',l:'Breskva'},{e:'üåÖ',l:'Zalazak'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåä',l:'Val'},{e:'üê∏',l:'≈Ωaba'},{e:'üåª',l:'Suncokret'},{e:'üçá',l:'Gro≈æƒëe'},{e:'üêß',l:'Pingvin'},{e:'üêò',l:'Slon'},{e:'üíô',l:'Srce'}] },
  { color:'#A855F7', name:'Ljubiƒçasta',
    correct:[{e:'üçá',l:'Gro≈æƒëe'},{e:'üîÆ',l:'Kristal'},{e:'ü¶Ñ',l:'Jednorog'},{e:'üçÜ',l:'Patlid≈æan'},{e:'üíú',l:'Srce'},{e:'üå∏',l:'Ljubiƒçica'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåä',l:'Val'},{e:'üê∏',l:'≈Ωaba'},{e:'‚òÄÔ∏è',l:'Sunce'},{e:'ü•ï',l:'Mrkva'},{e:'ü¶Å',l:'Lav'},{e:'üêò',l:'Slon'},{e:'üåª',l:'Suncokret'}] },
  { color:'#EC4899', name:'Ru≈æiƒçasta',
    correct:[{e:'üå∏',l:'Cvijet'},{e:'ü¶©',l:'Flamingo'},{e:'üç¨',l:'Bombon'},{e:'üéÄ',l:'Ma≈°na'},{e:'üê∑',l:'Svinja'},{e:'üå∫',l:'Hibiskus'}],
    wrong:  [{e:'üê∏',l:'≈Ωaba'},{e:'üåä',l:'Val'},{e:'‚òÄÔ∏è',l:'Sunce'},{e:'üçá',l:'Gro≈æƒëe'},{e:'ü¶Å',l:'Lav'},{e:'üêß',l:'Pingvin'},{e:'üêò',l:'Slon'},{e:'ü•ï',l:'Mrkva'}] },
  { color:'#FFFFFF', name:'Bijela',
    correct:[{e:'‚òÅÔ∏è',l:'Oblak'},{e:'‚õÑ',l:'Snjegoviƒç'},{e:'üêá',l:'Zec'},{e:'ü•õ',l:'Mlijeko'},{e:'üïäÔ∏è',l:'Golub'},{e:'üå®Ô∏è',l:'Snijeg'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåä',l:'Val'},{e:'üê∏',l:'≈Ωaba'},{e:'‚òÄÔ∏è',l:'Sunce'},{e:'üçá',l:'Gro≈æƒëe'},{e:'ü•ï',l:'Mrkva'},{e:'ü¶Å',l:'Lav'},{e:'üêß',l:'Pingvin'}] },
  { color:'#6B7280', name:'Siva',
    correct:[{e:'üêò',l:'Slon'},{e:'üå´Ô∏è',l:'Magla'},{e:'üê∫',l:'Vuk'},{e:'ü™®',l:'Kamen'},{e:'ü¶à',l:'Morski pas'},{e:'üê≠',l:'Mi≈°'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåä',l:'Val'},{e:'üê∏',l:'≈Ωaba'},{e:'‚òÄÔ∏è',l:'Sunce'},{e:'üå∏',l:'Cvijet'},{e:'üçä',l:'Naranƒça'},{e:'üåª',l:'Suncokret'},{e:'üçá',l:'Gro≈æƒëe'}] },
  { color:'#92400E', name:'Smeƒëa',
    correct:[{e:'üêª',l:'Medvjed'},{e:'üç´',l:'ƒåokolada'},{e:'ü¶î',l:'Je≈æ'},{e:'ü™µ',l:'Drvo'},{e:'üêï',l:'Pas'},{e:'üå∞',l:'Kesten'}],
    wrong:  [{e:'üçé',l:'Jabuka'},{e:'üåä',l:'Val'},{e:'üê∏',l:'≈Ωaba'},{e:'‚òÄÔ∏è',l:'Sunce'},{e:'üå∏',l:'Cvijet'},{e:'üê¨',l:'Delfin'},{e:'üåª',l:'Suncokret'},{e:'üçã',l:'Limun'}] },
];

// SLOVA: svaki level = jedno slovo, correct = vise rijeci koje pocinju tim slovom
const LETTERS = [
  // Lv1 ‚Äî slovo A
  // Avion ‚úàÔ∏è, Ananas üçç (PRAVI emoji!), Auto üöó
  { letter:'A', correct:[{e:'‚úàÔ∏è',l:'Avion'},{e:'üçç',l:'Ananas'},{e:'üöó',l:'Auto'}],
    wrong:[{e:'üê∂',l:'Pas'},{e:'üçï',l:'Pizza'},{e:'üê∏',l:'≈Ωaba'},{e:'üö¢',l:'Brod'},{e:'üçã',l:'Limun'},{e:'üåπ',l:'Ru≈æa'},{e:'üêò',l:'Slon'},{e:'üçì',l:'Jagoda'}] },

  // Lv2 ‚Äî slovo B
  // Brod üö¢, Buba üêõ, Banana üçå
  { letter:'B', correct:[{e:'üö¢',l:'Brod'},{e:'üêõ',l:'Buba'},{e:'üçå',l:'Banana'}],
    wrong:[{e:'‚úàÔ∏è',l:'Avion'},{e:'üçï',l:'Pizza'},{e:'üê∏',l:'≈Ωaba'},{e:'ü¶Å',l:'Lav'},{e:'üêò',l:'Slon'},{e:'üçé',l:'Jabuka'},{e:'üå∏',l:'Cvijet'},{e:'üöó',l:'Auto'}] },

  // Lv3 ‚Äî slovo C (i ƒå)
  // Cvijet üå∏, ƒåokolada üç´, Crv ü™±
  { letter:'C', correct:[{e:'üå∏',l:'Cvijet'},{e:'üç´',l:'ƒåokolada'},{e:'ü™±',l:'Crv'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'‚úàÔ∏è',l:'Avion'},{e:'üê∏',l:'≈Ωaba'},{e:'ü¶Å',l:'Lav'},{e:'üêò',l:'Slon'},{e:'üçé',l:'Jabuka'},{e:'üê∂',l:'Pas'},{e:'üçï',l:'Pizza'}] },

  // Lv4 ‚Äî slovo D
  // Duga üåà, Dinja üçâ, Dupin üê¨
  { letter:'D', correct:[{e:'üåà',l:'Duga'},{e:'üçâ',l:'Dinja'},{e:'üê¨',l:'Dupin'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üå∏',l:'Cvijet'},{e:'üê∏',l:'≈Ωaba'},{e:'‚úàÔ∏è',l:'Avion'},{e:'üçé',l:'Jabuka'},{e:'üêò',l:'Slon'},{e:'ü¶Å',l:'Lav'},{e:'üçå',l:'Banana'}] },

  // Lv5 ‚Äî slovo G
  // Gljiva üçÑ, Gro≈æƒëe üçá, Golub üïäÔ∏è
  { letter:'G', correct:[{e:'üçÑ',l:'Gljiva'},{e:'üçá',l:'Gro≈æƒëe'},{e:'üïäÔ∏è',l:'Golub'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üå∏',l:'Cvijet'},{e:'üêò',l:'Slon'},{e:'ü¶Å',l:'Lav'},{e:'‚úàÔ∏è',l:'Avion'},{e:'üçé',l:'Jabuka'},{e:'üê∏',l:'≈Ωaba'},{e:'üçï',l:'Pizza'}] },

  // Lv6 ‚Äî slovo H
  // Hrƒçak üêπ, Hobotnica üêô, Hljeb üçû
  { letter:'H', correct:[{e:'üêπ',l:'Hrƒçak'},{e:'üêô',l:'Hobotnica'},{e:'üçû',l:'Hljeb'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üå∏',l:'Cvijet'},{e:'üêò',l:'Slon'},{e:'üçÑ',l:'Gljiva'},{e:'‚úàÔ∏è',l:'Avion'},{e:'üçé',l:'Jabuka'},{e:'ü¶Å',l:'Lav'},{e:'üê∏',l:'≈Ωaba'}] },

  // Lv7 ‚Äî slovo I
  // Igloo üè†, Igraƒçka üß∏, Insekat ü¶ü  
  { letter:'I', correct:[{e:'üè†',l:'Igloo'},{e:'üß∏',l:'Igraƒçka'},{e:'ü¶ü',l:'Insekat'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üå∏',l:'Cvijet'},{e:'üêò',l:'Slon'},{e:'üçÑ',l:'Gljiva'},{e:'üçû',l:'Kruh'},{e:'üçé',l:'Jabuka'},{e:'ü¶Å',l:'Lav'},{e:'üê∏',l:'≈Ωaba'}] },

  // Lv8 ‚Äî slovo J
  // Jabuka üçé, Je≈æ ü¶î, Jagoda üçì
  { letter:'J', correct:[{e:'üçé',l:'Jabuka'},{e:'ü¶î',l:'Je≈æ'},{e:'üçì',l:'Jagoda'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üêò',l:'Slon'},{e:'üçÑ',l:'Gljiva'},{e:'üçû',l:'Kruh'},{e:'ü¶Å',l:'Lav'},{e:'üê∏',l:'≈Ωaba'},{e:'üå∏',l:'Cvijet'},{e:'üçå',l:'Banana'}] },

  // Lv9 ‚Äî slovo K
  // Krava üêÑ, Konj üê¥, Kruh üçû ‚Äî ne maƒçka jer maƒçka ‚â† kuna
  { letter:'K', correct:[{e:'üêÑ',l:'Krava'},{e:'üê¥',l:'Konj'},{e:'üîë',l:'Kljuƒç'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üçé',l:'Jabuka'},{e:'üêò',l:'Slon'},{e:'üçÑ',l:'Gljiva'},{e:'‚úàÔ∏è',l:'Avion'},{e:'ü¶Å',l:'Lav'},{e:'üê∏',l:'≈Ωaba'},{e:'üå∏',l:'Cvijet'}] },

  // Lv10 ‚Äî slovo L
  // Lav ü¶Å, Limun üçã, Leptir ü¶ã
  { letter:'L', correct:[{e:'ü¶Å',l:'Lav'},{e:'üçã',l:'Limun'},{e:'ü¶ã',l:'Leptir'}],
    wrong:[{e:'üö¢',l:'Brod'},{e:'üçé',l:'Jabuka'},{e:'üêò',l:'Slon'},{e:'üçÑ',l:'Gljiva'},{e:'‚úàÔ∏è',l:'Avion'},{e:'üê∏',l:'≈Ωaba'},{e:'üå∏',l:'Cvijet'},{e:'üê∂',l:'Pas'}] },
];

// BROJEVI: svaki level = jedan broj, correct = grupe s tim brojem predmeta
const NUMBERS = [
  { n:1, correct:[{e:'‚≠ê',l:'1 zvijezda'},{e:'üåô',l:'1 mjesec'},{e:'‚òÄÔ∏è',l:'1 sunce'}],
    wrong:[{e:'‚≠ê‚≠ê',l:'2 zvijezde'},{e:'üåôüåôüåô',l:'3 mjeseca'},{e:'‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è',l:'4 sunca'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',l:'5 zvijezda'},{e:'üåôüåô',l:'2 mjeseca'}] },
  { n:2, correct:[{e:'üê∂üê∂',l:'2 psa'},{e:'üå∏üå∏',l:'2 cvijeta'},{e:'‚≠ê‚≠ê',l:'2 zvijezde'}],
    wrong:[{e:'üê∂',l:'1 pas'},{e:'üå∏üå∏üå∏',l:'3 cvijeta'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê',l:'4 zvijezde'},{e:'üê±üê±üê±üê±üê±',l:'5 maƒçaka'},{e:'üåô',l:'1 mjesec'}] },
  { n:3, correct:[{e:'üçïüçïüçï',l:'3 pizze'},{e:'üê∏üê∏üê∏',l:'3 ≈æabe'},{e:'üåüüåüüåü',l:'3 zvijezde'}],
    wrong:[{e:'üçïüçï',l:'2 pizze'},{e:'üê∏üê∏üê∏üê∏',l:'4 ≈æabe'},{e:'üåü',l:'1 zvijezda'},{e:'üçïüçïüçïüçïüçï',l:'5 pizzi'},{e:'üê∏üê∏',l:'2 ≈æabe'}] },
  { n:4, correct:[{e:'üå∏üå∏üå∏üå∏',l:'4 cvijeta'},{e:'üçéüçéüçéüçé',l:'4 jabuke'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê',l:'4 zvijezde'}],
    wrong:[{e:'üå∏üå∏üå∏',l:'3 cvijeta'},{e:'üçéüçéüçéüçéüçé',l:'5 jabuka'},{e:'‚≠ê‚≠ê',l:'2 zvijezde'},{e:'üå∏üå∏üå∏üå∏üå∏üå∏',l:'6 cvjetova'},{e:'üçé',l:'1 jabuka'}] },
  { n:5, correct:[{e:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',l:'5 zvijezda'},{e:'üê∂üê∂üê∂üê∂üê∂',l:'5 pasa'},{e:'üçäüçäüçäüçäüçä',l:'5 naranƒçi'}],
    wrong:[{e:'‚≠ê‚≠ê‚≠ê‚≠ê',l:'4 zvijezde'},{e:'üê∂üê∂üê∂üê∂üê∂üê∂',l:'6 pasa'},{e:'üçäüçäüçä',l:'3 naranƒçe'},{e:'‚≠ê‚≠ê',l:'2 zvijezde'},{e:'üê∂',l:'1 pas'}] },
  { n:6, correct:[{e:'ü¶ãü¶ãü¶ãü¶ãü¶ãü¶ã',l:'6 leptira'},{e:'üçìüçìüçìüçìüçìüçì',l:'6 jagoda'},{e:'üêüüêüüêüüêüüêüüêü',l:'6 riba'}],
    wrong:[{e:'ü¶ãü¶ãü¶ãü¶ãü¶ã',l:'5 leptira'},{e:'üçìüçìüçìüçìüçìüçìüçì',l:'7 jagoda'},{e:'üêüüêüüêüüêü',l:'4 ribe'},{e:'ü¶ãü¶ãü¶ã',l:'3 leptira'},{e:'üçìüçì',l:'2 jagode'}] },
  { n:7, correct:[{e:'üçáüçáüçáüçáüçáüçáüçá',l:'7 grozda'},{e:'üåôüåôüåôüåôüåôüåôüåô',l:'7 mjeseci'},{e:'üê±üê±üê±üê±üê±üê±üê±',l:'7 maƒçaka'}],
    wrong:[{e:'üçáüçáüçáüçáüçáüçá',l:'6 grozda'},{e:'üåôüåôüåôüåôüåôüåôüåôüåô',l:'8 mjeseci'},{e:'üê±üê±üê±üê±üê±',l:'5 maƒçaka'},{e:'üçáüçáüçá',l:'3 grozda'},{e:'üåôüåô',l:'2 mjeseca'}] },
  { n:8, correct:[{e:'üêüüêüüêüüêüüêüüêüüêüüêü',l:'8 riba'},{e:'üå∏üå∏üå∏üå∏üå∏üå∏üå∏üå∏',l:'8 cvjetova'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',l:'8 zvijezda'}],
    wrong:[{e:'üêüüêüüêüüêüüêüüêüüêü',l:'7 riba'},{e:'üå∏üå∏üå∏üå∏üå∏üå∏üå∏üå∏üå∏',l:'9 cvjetova'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',l:'6 zvijezda'},{e:'üêüüêüüêüüêüüêü',l:'5 riba'},{e:'üå∏üå∏üå∏',l:'3 cvijeta'}] },
  { n:9, correct:[{e:'üåçüåçüåçüåçüåçüåçüåçüåçüåç',l:'9 planeta'},{e:'üêùüêùüêùüêùüêùüêùüêùüêùüêù',l:'9 pƒçela'},{e:'üçïüçïüçïüçïüçïüçïüçïüçïüçï',l:'9 pizzi'}],
    wrong:[{e:'üåçüåçüåçüåçüåçüåçüåçüåç',l:'8 planeta'},{e:'üêùüêùüêùüêùüêùüêùüêùüêùüêùüêù',l:'10 pƒçela'},{e:'üçïüçïüçïüçïüçïüçïüçï',l:'7 pizzi'},{e:'üåçüåçüåçüåçüåç',l:'5 planeta'},{e:'üêùüêùüêù',l:'3 pƒçele'}] },
  { n:10, correct:[{e:'üéàüéàüéàüéàüéàüéàüéàüéàüéàüéà',l:'10 balona'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',l:'10 zvijezda'},{e:'üçéüçéüçéüçéüçéüçéüçéüçéüçéüçé',l:'10 jabuka'}],
    wrong:[{e:'üéàüéàüéàüéàüéàüéàüéàüéàüéà',l:'9 balona'},{e:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',l:'8 zvijezda'},{e:'üçéüçéüçéüçéüçéüçé',l:'6 jabuka'},{e:'üéàüéàüéàüéàüéà',l:'5 balona'},{e:'‚≠ê‚≠ê‚≠ê',l:'3 zvijezde'}] },
];

// ================================================================
// STATE
// ================================================================
let G='', LVL=1, ROUND=0, TOTAL=0, SCORE=0;
let roundItems=[], correctSet=new Set(), selectedOk=new Set(), wrongCount=0, done=false;
let completed={boje:new Set(),slova:new Set(),broji:new Set(),memorij:new Set(),puzli:new Set(),umetaljka:new Set(),govor:new Set()};
let colorName='', currentN=0;
const ss=window.speechSynthesis;

// ================================================================
// WEB AUDIO ‚Äî veseli djeƒçji zvukovi
// ================================================================
let AC=null;
function getAC(){
  if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)();
  if(AC.state==='suspended') AC.resume();
  return AC;
}

// Svira melodiju (niz [frekvencija, trajanje_s])
function playMelody(notes, vol=0.25){
  const ac=getAC();
  let t=ac.currentTime+0.02;
  notes.forEach(([freq,dur,type='sine'])=>{
    if(!freq){ t+=dur; return; }
    const osc=ac.createOscillator();
    const gain=ac.createGain();
    osc.connect(gain); gain.connect(ac.destination);
    osc.type=type;
    osc.frequency.setValueAtTime(freq,t);
    // Malo vibrata za toplinu
    osc.frequency.linearRampToValueAtTime(freq*1.008, t+dur*0.5);
    osc.frequency.linearRampToValueAtTime(freq, t+dur);
    gain.gain.setValueAtTime(0,t);
    gain.gain.linearRampToValueAtTime(vol,t+0.02);
    gain.gain.exponentialRampToValueAtTime(0.001,t+dur);
    osc.start(t); osc.stop(t+dur+0.05);
    t+=dur*0.88;
  });
}

// Veseli "toƒçno!" zvuk ‚Äî uzlazna dur ljestvica
function playCorrect(){
  playMelody([
    [523,0.10],[659,0.10],[784,0.10],[1047,0.22]
  ], 0.2);
  // Dodaj zvjezdice - kratki sparkle
  setTimeout(()=>playMelody([[1319,0.08],[1568,0.14]],0.12),280);
}

// Super win zvuk ‚Äî fanfara
function playWin(){
  playMelody([
    [523,0.12],[523,0.12],[523,0.12],[415,0.09],[494,0.09],[523,0.30],
    [null,0.06],
    [523,0.12],[523,0.12],[523,0.12],[415,0.09],[494,0.09],[659,0.45],
  ], 0.22);
}

// Pogre≈°an odgovor ‚Äî smije≈°ni "boing" silazni
function playWrong(){
  const ac=getAC();
  const t=ac.currentTime+0.02;
  const osc=ac.createOscillator();
  const gain=ac.createGain();
  osc.connect(gain); gain.connect(ac.destination);
  osc.type='sawtooth';
  osc.frequency.setValueAtTime(300,t);
  osc.frequency.exponentialRampToValueAtTime(80,t+0.35);
  gain.gain.setValueAtTime(0.15,t);
  gain.gain.exponentialRampToValueAtTime(0.001,t+0.38);
  osc.start(t); osc.stop(t+0.4);
}

// Klik zvuk za button
function playClick(){
  playMelody([[880,0.06],[1100,0.06]],0.12);
}

// Intro jingle na home screen
function playJingle(){
  playMelody([
    [523,0.13],[659,0.13],[784,0.13],[1047,0.13],[784,0.13],[659,0.13],[523,0.26],
  ],0.18);
}

// ================================================================
// SPEECH ‚Äî TTS s djeƒçjim glasom
// ================================================================
function speak(txt,cb){
  if(!ss){ cb&&cb(); return; }
  ss.cancel();
  const u=new SpeechSynthesisUtterance(txt);

  // Poku≈°aj naƒái ≈æenski/djeƒçji glas
  const voices=ss.getVoices();
  // Prioritet: hr glas ‚Üí en ≈æenski glas s visokim pitchom
  const hr=voices.find(v=>v.lang.startsWith('hr'));
  const feminine=voices.find(v=>/female|woman|girl|zira|samantha|karen|tessa|moira|fiona|victoria|kathy|princess/i.test(v.name));
  const chosen=hr||feminine||voices[0];
  if(chosen) u.voice=chosen;

  u.lang=hr?'hr-HR':'hr-HR';
  u.rate=1.05;    // malo br≈æe = ≈æivahnije
  u.pitch=1.5;    // visoki pitch = djeƒçji glas!
  u.volume=1.0;

  const wave=document.getElementById('sound-wave');
  const hint=document.getElementById('speak-hint');
  if(wave){wave.classList.add('on'); if(hint) hint.style.display='none';}
  u.onend=u.onerror=()=>{ if(wave){wave.classList.remove('on'); if(hint) hint.style.display='';} cb&&cb(); };
  ss.speak(u);
}

function speakColor(){
  playClick();
  }

// ================================================================
// DOTS
// ================================================================
function initDots(){
  ['boje','slova','broji','memorij','puzli','umetaljka','govor'].forEach(g=>{
    const c=document.getElementById('dots-'+g); if(!c) return;
    c.innerHTML='';
    const maxLvl=(G==='govor')?20:10;
  for(let i=1;i<=maxLvl;i++){
      const d=document.createElement('div');
      d.className='dot'+(completed[g].has(i)?' done':'');
      c.appendChild(d);
    }
  });
}

// ================================================================
// NAV
// ================================================================
function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function goHome(){ ss&&ss.cancel(); clearInterval(memTimerInterval); initDots(); showScreen('screen-home'); }
function selectGame(g){ G=g; showLevelSelect(); }
function goLevels(){ ss&&ss.cancel(); clearInterval(memTimerInterval); puzDragPiece=null; puzDragEl=null; showLevelSelect(); }

function showLevelSelect(){
  const t={boje:'üé® Boje',slova:'üî§ Slova',broji:'üî¢ Brojevi',memorij:'üß† Memorij',puzli:'üß© Puzzle',umetaljka:'üè† Umetaljka',govor:'üó£Ô∏è Govorimo'};
  document.getElementById('lvl-title').textContent=t[G]+' ‚Äî Odaberi Level';
  const grid=document.getElementById('level-grid'); grid.innerHTML='';
  const pal=['#FF6B9D','#F97316','#FBBF24','#10B981','#06B6D4','#3B82F6','#A855F7','#EC4899','#84CC16','#78350F'];
  const maxLvl=(G==='govor')?20:10;
  for(let i=1;i<=maxLvl;i++){
    const unlocked=i===1||completed[G].has(i-1);
    const dn=completed[G].has(i);
    const btn=document.createElement('button');
    btn.className='lvl-btn'+(dn?' done':'')+(unlocked?'':' locked');
    if(unlocked) btn.style.cssText=`background:linear-gradient(135deg,${pal[i-1]}22,var(--card));border-color:${pal[i-1]}55;`;
    btn.innerHTML=`<span style="font-size:1.5rem;${!unlocked?'filter:grayscale(1)':''}">${unlocked?(dn?'‚≠ê':'üéÆ'):'üîí'}</span><span>${i}</span><span class="lvl-num">LEVEL</span>`;
    if(unlocked) btn.onclick=()=>{ if(G==='memorij') startMemory(i); else if(G==='puzli') startPuzzle(i); else if(G==='umetaljka') startUmetaljka(i); else if(G==='govor') startGovor(i); else startGame(i); };
    grid.appendChild(btn);
  }
  showScreen('screen-levels');
}

// ================================================================
// GAME
// ================================================================
// ================================================================
// Svaki level = 1 tema (boja/slovo/broj)
// 3 runde: runda 0=1 tocna, runda 1=2 tocne, runda 2=3 tocne
// ================================================================

function correctForRound(round){ return round+1; }   // 1, 2, 3
function totalWrongItems(){ return 5; }               // uvijek 5 krivih opcija

function startGame(lvl){
  LVL=lvl; SCORE=0; ROUND=0; TOTAL=3;
  document.getElementById('score-val').textContent='0';
  document.getElementById('color-stage').style.display=G==='boje'?'flex':'none';
  showScreen('screen-game');
  loadRound();
}

function loadRound(){
  if(ROUND>=TOTAL){ endLevel(); return; }
  const pct=(ROUND/TOTAL*100);
  document.getElementById('prog-bar').style.width=pct+'%';
  const nc=correctForRound(ROUND);
  document.getElementById('round-lbl').textContent=`Naƒëi ${nc} ${nc===1?'toƒçan':'toƒçna'}`;
  done=false; wrongCount=0; selectedOk=new Set(); roundItems=[];
  setFeedback('',''); document.getElementById('continue-btn').style.display='none';
  if(G==='boje') loadColorRound();
  else if(G==='slova') loadLetterRound();
  else loadNumberRound();
}

// ---- COLOR ----
function loadColorRound(){
  const obj=COLORS[LVL-1];
  colorName=obj.name;
  const circle=document.getElementById('color-circle');
  circle.style.background=obj.color;
  circle.style.setProperty('--cc',obj.color);
  document.getElementById('q-label').textContent='Klikni SVE ≈°to je ove boje üëÜ';
  document.getElementById('q-text').textContent='';
  document.getElementById('color-name-label').textContent=obj.name;

  const nc=correctForRound(ROUND);
  // Shuffle correct pool and pick nc items (different each round using ROUND as seed offset)
  const corrPool=[...obj.correct].sort(()=>Math.random()-.5);
  const corr=corrPool.slice(0,nc);
  const wrong=[...obj.wrong].sort(()=>Math.random()-.5).slice(0,totalWrongItems());
  correctSet=new Set(corr.map(x=>x.e));
  roundItems=[...corr.map(x=>({e:x.e,l:x.l,ok:true})),...wrong.map(x=>({e:x.e,l:x.l,ok:false}))].sort(()=>Math.random()-.5);
  renderClickItems();
}

// ---- LETTER ----
function loadLetterRound(){
  const obj=LETTERS[LVL-1];
  document.getElementById('q-label').textContent='Klikni slike koje poƒçinju s ovim slovom üëÜ';
  document.getElementById('q-text').innerHTML=`<span style="font-size:4.5rem;font-family:'Fredoka One',cursive;filter:drop-shadow(0 0 20px rgba(168,85,247,.7))">${obj.letter}</span>`;

  const nc=correctForRound(ROUND);
  const corrPool=[...obj.correct].sort(()=>Math.random()-.5);
  const corr=corrPool.slice(0,nc);
  const wrong=[...obj.wrong].sort(()=>Math.random()-.5).slice(0,totalWrongItems());
  correctSet=new Set(corr.map(x=>x.e));
  roundItems=[...corr.map(x=>({e:x.e,l:x.l,ok:true})),...wrong.map(x=>({e:x.e,l:x.l,ok:false}))].sort(()=>Math.random()-.5);
  renderClickItems();
}

// ---- NUMBER ----
function loadNumberRound(){
  const obj=NUMBERS[LVL-1];
  currentN=obj.n;
  document.getElementById('q-label').textContent='Klikni sve grupe s toƒçnim brojem üëÜ';
  document.getElementById('q-text').innerHTML=`<span style="font-size:5rem;font-family:'Fredoka One',cursive;filter:drop-shadow(0 0 24px rgba(16,185,129,.7))">${obj.n}</span>`;

  const nc=correctForRound(ROUND);
  const corrPool=[...obj.correct].sort(()=>Math.random()-.5);
  const corr=corrPool.slice(0,nc);
  const wrong=[...obj.wrong].sort(()=>Math.random()-.5).slice(0,totalWrongItems());
  correctSet=new Set(corr.map(x=>x.e));
  roundItems=[...corr.map(x=>({e:x.e,l:x.l,ok:true})),...wrong.map(x=>({e:x.e,l:x.l,ok:false}))].sort(()=>Math.random()-.5);
  renderClickItems();
}

// ================================================================
// RENDER
// ================================================================
function renderClickItems(){
  const grid=document.getElementById('items-grid'); grid.innerHTML='';
  roundItems.forEach(item=>{
    const el=document.createElement('div');
    el.className='click-item';
    el.innerHTML=`<span class="ci-emoji">${item.e}</span><span class="ci-name">${item.l}</span>`;
    el.onclick=()=>handleClick(el,item);
    grid.appendChild(el);
  });
}



// ================================================================
// CLICK
// ================================================================
function handleClick(el,item){
  if(done||el.classList.contains('c-disabled')) return;
  if(item.ok){
    selectedOk.add(item.e);
    el.classList.add('c-correct','c-disabled');
    el.innerHTML+=`<span class="ck">‚úÖ</span>`;
    playCorrect();
    if(selectedOk.size>=correctSet.size){
      done=true;
      revealAll();
      SCORE+=Math.max(10-wrongCount*2,2);
      document.getElementById('score-val').textContent=SCORE;
      setFeedback('good',['üéâ Bravo!','‚úÖ Toƒçno!','üåü Odliƒçno!','üëè Super!'][Math.floor(Math.random()*4)]);
      setTimeout(()=>{document.getElementById('continue-btn').style.display='block';},600);
    }
  } else {
    wrongCount++;
    el.classList.add('c-wrong');
    playWrong();
    setTimeout(()=>el.classList.remove('c-wrong'),400);
    setFeedback('bad',['‚ùå Poku≈°aj ponovo!','ü§î Nije to...','Tra≈æi dalje!'][Math.floor(Math.random()*3)]);
  }
}



function revealAll(){
  document.querySelectorAll('.click-item').forEach(el=>{
    el.classList.add('c-disabled');
  });
}

function setFeedback(type,msg){
  const bar=document.getElementById('feedback-bar');
  bar.className='feedback-bar'+(type?' show '+type:'');
  bar.textContent=msg;
}

function nextRound(){ ROUND++; loadRound(); }

// ================================================================
// END
// ================================================================
function endLevel(){
  document.getElementById('prog-bar').style.width='100%';
  completed[G].add(LVL);
  const max=TOTAL*10, pct=SCORE/max;
  const stars=pct>=.85?3:pct>=.55?2:1;
  document.getElementById('res-emoji').textContent=stars===3?'üéâ':stars===2?'üòä':'üí™';
  document.getElementById('res-title').textContent=stars===3?'Savr≈°eno!':stars===2?'Odliƒçno!':'Probaj ponovo!';
  document.getElementById('res-sub').textContent=`Bodovi: ${SCORE} / ${max}`;
  document.getElementById('res-stars').innerHTML='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars);
  document.getElementById('next-lvl-btn').style.display=LVL<10?'':'none';
  document.getElementById('result-overlay').classList.add('show');
  if(stars===3){
    confetti();
    setTimeout(playWin,200);
  } else {
    setTimeout(()=>playMelody([[440,0.18],[392,0.18],[349,0.35]],0.18),200);
  }
  if(stars>=2) setTimeout(()=>speak('Bravo!'),900);
}
function retryLevel(){ playClick(); document.getElementById('result-overlay').classList.remove('show'); if(G==='memorij') startMemory(LVL); else if(G==='puzli') startPuzzle(LVL); else if(G==='umetaljka') startUmetaljka(LVL); else if(G==='govor') startGovor(LVL); else startGame(LVL); }
function nextLevel(){ playClick(); document.getElementById('result-overlay').classList.remove('show'); if(G==='memorij'){ if(LVL<10) startMemory(LVL+1); else goLevels(); } else if(G==='puzli'){ if(LVL<10) startPuzzle(LVL+1); else goLevels(); } else if(G==='umetaljka'){ if(LVL<10) startUmetaljka(LVL+1); else goLevels(); } else if(G==='govor'){ if(LVL<20) startGovor(LVL+1); else goLevels(); } else { if(LVL<10) startGame(LVL+1); else goLevels(); } }

// ================================================================
// CONFETTI
// ================================================================
function confetti(){
  const cols=['#FF6B9D','#FBBF24','#10B981','#3B82F6','#A855F7','#F97316'];
  for(let i=0;i<70;i++){
    const el=document.createElement('div'); el.className='cf';
    el.style.left=Math.random()*100+'vw';
    el.style.background=cols[~~(Math.random()*cols.length)];
    el.style.borderRadius=Math.random()>.5?'50%':'2px';
    el.style.animationDuration=(1.5+Math.random()*2.5)+'s';
    el.style.animationDelay=(Math.random()*.8)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),4500);
  }
}


// ================================================================
// MEMORY GAME
// ================================================================
const MEM_EMOJIS = [
  'üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ',
  'ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü',
  'ü¶Ö','ü¶â','ü¶á','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü',
  'üå∏','üå∫','üåª','üåπ','üçé','üçä','üçã','üçá','üçì','üçë',
  'üéà','üéÄ','üéÅ','üéÇ','‚≠ê','üåô','‚òÄÔ∏è','üåà','‚ùÑÔ∏è','üéµ'
];

let memCards=[], memFlipped=[], memMatched=0, memMoves=0, memPairs=0;
let memBlocked=false, memTimer=0, memTimerInterval=null;
const memCompleted = new Set();

// Level config: [totalCards, pairsToFind]
// lvl 1: 4 cards, 1 pair aktivan (ostale su dummy? Ne ‚Äî svi su parovi)
// Bolje: totalCards = pari*2, activePairs = ono sto treba naci
const MEM_LEVELS = [
  {cards:4,  pairs:1},  // lv1: 4 kartice, naƒëi 1 par
  {cards:6,  pairs:1},  // lv2
  {cards:8,  pairs:2},  // lv3
  {cards:8,  pairs:2},  // lv4
  {cards:10, pairs:3},  // lv5
  {cards:10, pairs:3},  // lv6
  {cards:12, pairs:4},  // lv7
  {cards:12, pairs:4},  // lv8
  {cards:16, pairs:5},  // lv9
  {cards:16, pairs:6},  // lv10
];

function startMemory(lvl){
  LVL=lvl; memMoves=0; memMatched=0; memFlipped=[]; memBlocked=false;
  clearInterval(memTimerInterval); memTimer=0;
  document.getElementById('mem-score-val').textContent='0';
  document.getElementById('mem-moves-lbl').textContent='0 poteza';
  document.getElementById('mem-timer').textContent='0';

  const cfg=MEM_LEVELS[lvl-1];
  memPairs=cfg.cards/2;  // ukupno parova = kartice/2 (sve kartice imaju par)

  // Pick random emojis for this level
  const shuffledEmojis=[...MEM_EMOJIS].sort(()=>Math.random()-.5).slice(0,memPairs);

  // Create pairs array and shuffle
  memCards=[...shuffledEmojis,...shuffledEmojis].sort(()=>Math.random()-.5);

  // Update UI
  document.getElementById('mem-pairs-info').textContent=
    `Level ${lvl} ‚Äî naƒëi sve ${memPairs} ${memPairs===1?'par':'parova'}!`;
  document.getElementById('mem-pairs-left').textContent=memPairs;
  document.getElementById('mem-prog-bar').style.width='0%';

  // Build grid columns based on card count
  const cols = cfg.cards<=6 ? 3 : cfg.cards<=10 ? 4 : 4;
  const grid=document.getElementById('mem-grid');
  grid.style.gridTemplateColumns=`repeat(${cols},1fr)`;

  renderMemGrid();
  showScreen('screen-memory');

  // Start timer after first flip
  memTimerInterval=null;

}

function renderMemGrid(){
  const grid=document.getElementById('mem-grid');
  grid.innerHTML='';
  memCards.forEach((emoji,idx)=>{
    const wrap=document.createElement('div');
    wrap.className='mem-card-wrap';
    wrap.dataset.idx=idx;
    wrap.innerHTML=`
      <div class="mem-card" id="mc-${idx}">
        <div class="mem-card-face mem-card-back">
          <span class="mem-card-back-icon">üåü</span>
        </div>
        <div class="mem-card-face mem-card-front">${emoji}</div>
      </div>`;
    wrap.addEventListener('click',()=>flipMemCard(idx,emoji));
    grid.appendChild(wrap);
  });
}

function flipMemCard(idx, emoji){
  if(memBlocked) return;
  const card=document.getElementById('mc-'+idx);
  if(!card || card.classList.contains('flipped') || card.classList.contains('matched')) return;

  // Start timer on first flip
  if(!memTimerInterval){
    memTimerInterval=setInterval(()=>{
      memTimer++;
      document.getElementById('mem-timer').textContent=memTimer;
    },1000);
  }

  card.classList.add('flipped');
  memFlipped.push({idx,emoji});
  playClick();

  if(memFlipped.length===2){
    memBlocked=true;
    memMoves++;
    document.getElementById('mem-moves-lbl').textContent=`${memMoves} potez${memMoves===1?'':'a'}`;

    const [a,b]=memFlipped;
    if(a.emoji===b.emoji){
      // MATCH!
      setTimeout(()=>{
        document.getElementById('mc-'+a.idx).classList.add('matched');
        document.getElementById('mc-'+b.idx).classList.add('matched');
        memMatched++;
        const left=memPairs-memMatched;
        document.getElementById('mem-pairs-left').textContent=left;
        document.getElementById('mem-prog-bar').style.width=(memMatched/memPairs*100)+'%';
        playCorrect();
        memFlipped=[];
        memBlocked=false;
        if(memMatched>=memPairs) setTimeout(endMemory,600);
      },400);
    } else {
      // NO MATCH
      setTimeout(()=>{
        document.getElementById('mc-'+a.idx).classList.remove('flipped');
        document.getElementById('mc-'+b.idx).classList.remove('flipped');
        playWrong();
        memFlipped=[];
        memBlocked=false;
      },900);
    }
  }
}

function endMemory(){
  clearInterval(memTimerInterval);
  completed[G].add(LVL);

  // Score based on moves and time
  const idealMoves=memPairs;
  const efficiency=Math.max(0, 1-(memMoves-idealMoves)/(idealMoves*2));
  const timeBonus=Math.max(0,1-memTimer/(memPairs*15));
  const pct=(efficiency*0.7+timeBonus*0.3);
  const stars=pct>=.7?3:pct>=.4?2:1;
  const score=Math.round(pct*100);

  document.getElementById('mem-score-val').textContent=score;
  document.getElementById('res-emoji').textContent=stars===3?'üß†':stars===2?'üòä':'üí™';
  document.getElementById('res-title').textContent=stars===3?'Genij!':stars===2?'Odliƒçno!':'Probaj ponovo!';
  document.getElementById('res-sub').textContent=`${memMoves} poteza ‚Ä¢ ${memTimer}s ‚Ä¢ Bodovi: ${score}`;
  document.getElementById('res-stars').innerHTML='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars);
  document.getElementById('next-lvl-btn').style.display=LVL<10?'':'none';
  document.getElementById('result-overlay').classList.add('show');

  if(stars===3){ confetti(); setTimeout(playWin,200); }
  else { setTimeout(()=>playMelody([[440,0.18],[392,0.18],[349,0.35]],0.18),200); }
  if(stars>=2) setTimeout(()=>speak('Bravo!'),900);
}


// ================================================================
// PUZZLE GAME
// ================================================================

// Lijepe slike koje djeca vole ‚Äî koristimo Canvas da nacrtamo
// svaku sliku od emojija i boja
const PUZZLE_IMAGES = [
  { label:'üåà Duga',     draw: drawRainbow },
  { label:'üåª Suncokret', draw: drawSunflower },
  { label:'üê∏ ≈Ωaba',     draw: drawFrog },
  { label:'üöÇ Vlak',     draw: drawTrain },
  { label:'üè† Kuƒáica',   draw: drawHouse },
  { label:'üê† Riba',     draw: drawFish },
  { label:'üåô Noƒá',      draw: drawNight },
  { label:'ü¶ã Leptir',   draw: drawButterfly },
  { label:'üçé Jabuka',   draw: drawApple },
  { label:'üöÄ Raketa',   draw: drawRocket },
];

// Level config: [cols, rows] ‚Äî komadi
const PUZ_LEVELS = [
  {cols:2, rows:1},  // lv1: 2 komada
  {cols:2, rows:2},  // lv2: 4 komada
  {cols:4, rows:2},  // lv3: 8 komada
  {cols:2, rows:1},  // lv4: 2 komada (nova slika)
  {cols:2, rows:2},  // lv5: 4
  {cols:4, rows:2},  // lv6: 8
  {cols:2, rows:1},  // lv7
  {cols:2, rows:2},  // lv8
  {cols:4, rows:2},  // lv9
  {cols:4, rows:2},  // lv10: 8 komada
];

let puzCols=2, puzRows=1, puzPieceW=0, puzPieceH=0;
let puzPlaced=0, puzTotal=0;
let puzDragPiece=null, puzDragEl=null;
let puzCompleted = new Set();
const PUZ_SIZE = 280; // canvas size

function startPuzzle(lvl){
  LVL=lvl;
  const cfg=PUZ_LEVELS[lvl-1];
  puzCols=cfg.cols; puzRows=cfg.rows;
  puzTotal=puzCols*puzRows;
  puzPlaced=0;
  puzDragPiece=null; puzDragEl=null;

  document.getElementById('puz-level-lbl').textContent=`Level ${lvl}`;
  document.getElementById('puz-prog-bar').style.width='0%';
  document.getElementById('puz-done-banner').style.display='none';
  document.getElementById('puz-top-label').style.display='';
  document.getElementById('puz-tray').style.display='';

  // Draw full image on offscreen canvas
  const imgIdx=(lvl-1) % PUZZLE_IMAGES.length;
  const img=PUZZLE_IMAGES[imgIdx];
  const full=document.createElement('canvas');
  full.width=PUZ_SIZE; full.height=PUZ_SIZE;
  img.draw(full.getContext('2d'), PUZ_SIZE, PUZ_SIZE);

  // Store full canvas for later use in puzzleDone
  window._puzFullCanvas = full;

  // Preview
  const prev=document.getElementById('puz-preview-canvas');
  prev.width=110; prev.height=110;
  prev.style.width='110px'; prev.style.height='110px';
  prev.getContext('2d').drawImage(full,0,0,110,110);

  // Piece size (use whole PUZ_SIZE divided evenly)
  puzPieceW=Math.floor(PUZ_SIZE/puzCols);
  puzPieceH=Math.floor(PUZ_SIZE/puzRows);

  // Board
  const board=document.getElementById('puz-board');
  board.innerHTML='';
  board.style.cssText=`display:grid;grid-template-columns:repeat(${puzCols},${puzPieceW}px);grid-template-rows:repeat(${puzRows},${puzPieceH}px);width:${puzPieceW*puzCols}px;height:${puzPieceH*puzRows}px;border-radius:16px;overflow:hidden;border:3px solid rgba(255,255,255,.15);box-shadow:0 8px 40px rgba(0,0,0,.5);position:relative;`;

  for(let r=0;r<puzRows;r++){
    for(let c=0;c<puzCols;c++){
      const slot=document.createElement('div');
      slot.className='puz-slot';
      slot.style.width=puzPieceW+'px';
      slot.style.height=puzPieceH+'px';
      slot.dataset.col=c; slot.dataset.row=r;
      setupSlotDrop(slot);
      board.appendChild(slot);
    }
  }

  // Build pieces ‚Äî draw each piece directly onto its own canvas
  const pieces=[];
  for(let r=0;r<puzRows;r++){
    for(let c=0;c<puzCols;c++){
      const cv=document.createElement('canvas');
      cv.width=puzPieceW; cv.height=puzPieceH;
      cv.style.width=puzPieceW+'px';
      cv.style.height=puzPieceH+'px';
      // Draw the correct slice from full image
      cv.getContext('2d').drawImage(full,
        c*puzPieceW, r*puzPieceH, puzPieceW, puzPieceH,
        0, 0, puzPieceW, puzPieceH);
      cv.className='puz-piece';
      cv.dataset.col=String(c);
      cv.dataset.row=String(r);
      setupPieceDrag(cv);
      pieces.push(cv);
    }
  }

  // Shuffle pieces into tray
  pieces.sort(()=>Math.random()-.5);
  const tray=document.getElementById('puz-tray');
  tray.innerHTML='';
  pieces.forEach(p=>tray.appendChild(p));

  showScreen('screen-puzzle');
}

function setupPieceDrag(el){
  el.draggable=true;
  el.addEventListener('dragstart', e=>{
    puzDragPiece={col:+el.dataset.col, row:+el.dataset.row};
    puzDragEl=el;
    el.classList.add('dragging-pc');
    e.dataTransfer.setData('text/plain','piece');
  });
  el.addEventListener('dragend', ()=>el.classList.remove('dragging-pc'));

  // Touch support
  let ghost=null;
  el.addEventListener('touchstart', e=>{
    puzDragPiece={col:+el.dataset.col, row:+el.dataset.row};
    puzDragEl=el;
    const t=e.touches[0];
    ghost=document.createElement('canvas');
    ghost.width=puzPieceW; ghost.height=puzPieceH;
    ghost.getContext('2d').drawImage(el,0,0);
    ghost.style.cssText=`position:fixed;width:${puzPieceW}px;height:${puzPieceH}px;opacity:.8;pointer-events:none;z-index:999;border-radius:10px;left:${t.clientX-puzPieceW/2}px;top:${t.clientY-puzPieceH/2}px;`;
    document.body.appendChild(ghost);
    el.style.opacity='.3';
  },{passive:true});
  el.addEventListener('touchmove', e=>{
    if(!ghost) return;
    const t=e.touches[0];
    ghost.style.left=(t.clientX-puzPieceW/2)+'px';
    ghost.style.top=(t.clientY-puzPieceH/2)+'px';
    e.preventDefault();
  },{passive:false});
  el.addEventListener('touchend', e=>{
    if(ghost){ ghost.remove(); ghost=null; }
    el.style.opacity='';
    const t=e.changedTouches[0];
    const hit=document.elementFromPoint(t.clientX, t.clientY);
    const slot=hit&&hit.closest('.puz-slot');
    if(slot) dropOnSlot(slot);
    else { puzDragPiece=null; puzDragEl=null; }
  });
}

function setupSlotDrop(slot){
  slot.addEventListener('dragover', e=>{ e.preventDefault(); if(!slot.classList.contains('filled')) slot.classList.add('over'); });
  slot.addEventListener('dragleave', ()=>slot.classList.remove('over'));
  slot.addEventListener('drop', e=>{ e.preventDefault(); slot.classList.remove('over'); dropOnSlot(slot); });
}

function dropOnSlot(slot){
  if(!puzDragPiece||!puzDragEl) return;
  if(slot.classList.contains('filled')) return;

  const sc=+slot.dataset.col, sr=+slot.dataset.row;

  if(puzDragPiece.col===sc && puzDragPiece.row===sr){
    // CORRECT ‚Äî draw piece directly onto slot using a new canvas
    const placed=document.createElement('canvas');
    placed.width=puzPieceW; placed.height=puzPieceH;
    placed.style.cssText=`display:block;width:${puzPieceW}px;height:${puzPieceH}px;`;
    // Copy pixel data from drag source canvas
    placed.getContext('2d').drawImage(puzDragEl, 0, 0);

    slot.innerHTML='';
    slot.classList.add('filled','correct-flash');
    slot.style.padding='0';
    slot.style.border='none';
    slot.appendChild(placed);

    puzDragEl.remove();
    playCorrect();
    puzPlaced++;
    document.getElementById('puz-prog-bar').style.width=(puzPlaced/puzTotal*100)+'%';
    if(puzPlaced>=puzTotal) setTimeout(puzzleDone, 500);
  } else {
    playWrong();
    slot.classList.add('over');
    setTimeout(()=>slot.classList.remove('over'),400);
  }
  puzDragPiece=null; puzDragEl=null;
}

function puzzleDone(){
  completed['puzli'].add(LVL);
  confetti();
  setTimeout(playWin, 200);
  setTimeout(()=>speak('Bravo!'), 600);

  // Overlay full completed image on board with pop animation
  const board=document.getElementById('puz-board');
  const fullCv=document.createElement('canvas');
  fullCv.width=puzPieceW*puzCols; fullCv.height=puzPieceH*puzRows;
  fullCv.getContext('2d').drawImage(window._puzFullCanvas, 0, 0, puzPieceW*puzCols, puzPieceH*puzRows);
  fullCv.style.cssText=`position:absolute;inset:0;width:100%;height:100%;border-radius:13px;z-index:2;animation:popIn .5s cubic-bezier(.34,1.56,.64,1);`;
  board.appendChild(fullCv);

  document.getElementById('puz-done-banner').style.display='block';
  document.getElementById('puz-top-label').style.display='none';
  document.getElementById('puz-tray').style.display='none';

  setTimeout(()=>{
    document.getElementById('res-emoji').textContent='üß©';
    document.getElementById('res-title').textContent=LVL<10?'Bravo! Idemo dalje!':'Zavr≈°io si sve puzzleve!';
    document.getElementById('res-sub').textContent=`Level ${LVL} ‚Äî slo≈æeno!`;
    document.getElementById('res-stars').innerHTML='‚≠ê‚≠ê‚≠ê';
    document.getElementById('next-lvl-btn').style.display=LVL<10?'':'none';
    document.getElementById('result-overlay').classList.add('show');
  }, 1400);
}

// ================================================================
// DRAW FUNCTIONS ‚Äî crtamo slike emojijima na canvasu
// ================================================================
// Compat roundRect for older browsers
function rrect(ctx, x, y, w, h, r){
  if(typeof r==='number') r=[r,r,r,r];
  ctx.beginPath();
  ctx.moveTo(x+r[0],y);
  ctx.lineTo(x+w-r[1],y); ctx.quadraticCurveTo(x+w,y,x+w,y+r[1]);
  ctx.lineTo(x+w,y+h-r[2]); ctx.quadraticCurveTo(x+w,y+h,x+w-r[2],y+h);
  ctx.lineTo(x+r[3],y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r[3]);
  ctx.lineTo(x,y+r[0]); ctx.quadraticCurveTo(x,y,x+r[0],y);
  ctx.closePath();
}
function drawRainbow(ctx, w, h){
  // Sky
  const sky=ctx.createLinearGradient(0,0,0,h);
  sky.addColorStop(0,'#87CEEB'); sky.addColorStop(1,'#E0F4FF');
  ctx.fillStyle=sky; ctx.fillRect(0,0,w,h);
  // Rainbow arcs
  const colors=['#FF0000','#FF7F00','#FFFF00','#00CC00','#0000FF','#8B00FF'];
  const cx=w/2, cy=h*0.85, baseR=w*0.7;
  colors.forEach((c,i)=>{
    ctx.beginPath();
    ctx.strokeStyle=c; ctx.lineWidth=w*0.055;
    ctx.arc(cx,cy,baseR-i*w*0.065,Math.PI,0);
    ctx.stroke();
  });
  // Green ground
  ctx.fillStyle='#5DB85D';
  ctx.fillRect(0,h*0.85,w,h*0.15);
  // Clouds
  drawCloud(ctx, w*0.12, h*0.18, w*0.12);
  drawCloud(ctx, w*0.78, h*0.12, w*0.1);
}

function drawCloud(ctx,x,y,r){
  ctx.fillStyle='white';
  [[0,0,1],[-.5,-.2,.7],[.5,-.15,.75],[-.9,.1,.6],[.9,.1,.6]].forEach(([dx,dy,s])=>{
    ctx.beginPath(); ctx.arc(x+dx*r,y+dy*r,r*s,0,Math.PI*2); ctx.fill();
  });
}

function drawSunflower(ctx, w, h){
  // Sky
  ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,w,h*0.65);
  // Ground
  ctx.fillStyle='#6DB56D'; ctx.fillRect(0,h*0.65,w,h*0.35);
  // Stem
  ctx.strokeStyle='#4a7c3f'; ctx.lineWidth=w*0.06;
  ctx.beginPath(); ctx.moveTo(w/2,h*0.65); ctx.lineTo(w/2,h*0.35); ctx.stroke();
  // Petals
  const cx=w/2, cy=h*0.3, pr=w*0.18, pd=w*0.22;
  ctx.fillStyle='#FFD700';
  for(let i=0;i<12;i++){
    const a=i/12*Math.PI*2;
    ctx.beginPath();
    ctx.ellipse(cx+Math.cos(a)*pd, cy+Math.sin(a)*pd, pr*0.45, pr*0.2, a, 0, Math.PI*2);
    ctx.fill();
  }
  // Center
  ctx.fillStyle='#8B4513';
  ctx.beginPath(); ctx.arc(cx,cy,pr*0.55,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#6B3410';
  for(let i=0;i<20;i++){
    const a=Math.random()*Math.PI*2, r=Math.random()*pr*0.45;
    ctx.beginPath(); ctx.arc(cx+Math.cos(a)*r,cy+Math.sin(a)*r,2,0,Math.PI*2); ctx.fill();
  }
}

function drawFrog(ctx, w, h){
  ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,w,h);
  // Lily pad
  ctx.fillStyle='#2D8A2D';
  ctx.beginPath(); ctx.ellipse(w/2,h*0.78,w*0.42,h*0.18,0,0,Math.PI*2); ctx.fill();
  // Body
  ctx.fillStyle='#3CB371';
  ctx.beginPath(); ctx.ellipse(w/2,h*0.58,w*0.3,h*0.22,0,0,Math.PI*2); ctx.fill();
  // Head
  ctx.beginPath(); ctx.ellipse(w/2,h*0.38,w*0.26,h*0.2,0,0,Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(w*0.38,h*0.3,w*0.08,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(w*0.62,h*0.3,w*0.08,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#1a1a1a';
  ctx.beginPath(); ctx.arc(w*0.39,h*0.3,w*0.04,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(w*0.63,h*0.3,w*0.04,0,Math.PI*2); ctx.fill();
  // Smile
  ctx.strokeStyle='#1a5c1a'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.arc(w/2,h*0.42,w*0.1,0.2,Math.PI-0.2); ctx.stroke();
  // Legs
  ctx.fillStyle='#3CB371';
  ctx.beginPath(); ctx.ellipse(w*0.22,h*0.68,w*0.1,h*0.06,-0.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(w*0.78,h*0.68,w*0.1,h*0.06,0.5,0,Math.PI*2); ctx.fill();
}

function drawTrain(ctx, w, h){
  // Sky
  ctx.fillStyle='#B8D4E8'; ctx.fillRect(0,0,w,h*0.6);
  // Ground
  ctx.fillStyle='#8B7355'; ctx.fillRect(0,h*0.78,w,h*0.22);
  // Rails
  ctx.strokeStyle='#555'; ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(0,h*0.82); ctx.lineTo(w,h*0.82); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,h*0.88); ctx.lineTo(w,h*0.88); ctx.stroke();
  for(let x=0;x<w;x+=w*0.1){
    ctx.beginPath(); ctx.moveTo(x,h*0.82); ctx.lineTo(x,h*0.88); ctx.stroke();
  }
  // Train body
  ctx.fillStyle='#E53935';
  rrect(ctx,w*0.05,h*0.52,w*0.8,h*0.28,8); ctx.fill;
  // Windows
  ctx.fillStyle='#FFD54F';
  [0.18,0.42,0.66].forEach(xp=>{
    rrect(ctx,w*xp,h*0.57,w*0.18,h*0.12,4); ctx.fill;
  });
  // Chimney
  ctx.fillStyle='#B71C1C';
  ctx.fillRect(w*0.62,h*0.42,w*0.1,h*0.12);
  // Smoke
  ctx.fillStyle='rgba(200,200,200,.7)';
  ctx.beginPath(); ctx.arc(w*0.67,h*0.35,w*0.06,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(w*0.71,h*0.28,w*0.04,0,Math.PI*2); ctx.fill();
  // Wheels
  ctx.fillStyle='#333';
  [0.2,0.45,0.7].forEach(xp=>{
    ctx.beginPath(); ctx.arc(w*xp,h*0.82,w*0.08,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#666';
    ctx.beginPath(); ctx.arc(w*xp,h*0.82,w*0.04,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#333';
  });
}

function drawHouse(ctx, w, h){
  // Sky
  const sky=ctx.createLinearGradient(0,0,0,h*0.6);
  sky.addColorStop(0,'#4FC3F7'); sky.addColorStop(1,'#B3E5FC');
  ctx.fillStyle=sky; ctx.fillRect(0,0,w,h*0.6);
  // Ground
  ctx.fillStyle='#81C784'; ctx.fillRect(0,h*0.72,w,h*0.28);
  // Path
  ctx.fillStyle='#D4A76A';
  ctx.beginPath(); ctx.moveTo(w*0.4,h); ctx.lineTo(w*0.6,h); ctx.lineTo(w*0.55,h*0.72); ctx.lineTo(w*0.45,h*0.72); ctx.fill();
  // House walls
  ctx.fillStyle='#FFF9C4';
  rrect(ctx,w*0.12,h*0.44,w*0.76,h*0.3,4); ctx.fill;
  ctx.strokeStyle='#E6D670'; ctx.lineWidth=2; ctx.stroke();
  // Roof
  ctx.fillStyle='#E53935';
  ctx.beginPath(); ctx.moveTo(w*0.05,h*0.45); ctx.lineTo(w/2,h*0.18); ctx.lineTo(w*0.95,h*0.45); ctx.fill();
  // Door
  ctx.fillStyle='#795548';
  rrect(ctx,w*0.43,h*0.6,w*0.14,h*0.14,3,3,0,0); ctx.fill;
  ctx.fillStyle='#FFD700';
  ctx.beginPath(); ctx.arc(w*0.54,h*0.67,2.5,0,Math.PI*2); ctx.fill();
  // Windows
  ctx.fillStyle='#81D4FA';
  [[0.2,0.51],[0.67,0.51]].forEach(([x,y])=>{
    rrect(ctx,w*x,h*y,w*0.16,h*0.1,3); ctx.fill;
    ctx.strokeStyle='#29B6F6'; ctx.lineWidth=1.5; ctx.stroke();
    ctx.strokeStyle='#B0BEC5'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(w*x+w*0.08,h*y); ctx.lineTo(w*x+w*0.08,h*(y+0.1)); ctx.stroke();
  });
  // Chimney
  ctx.fillStyle='#8D6E63';
  ctx.fillRect(w*0.65,h*0.24,w*0.1,h*0.12);
  // Sun
  ctx.fillStyle='#FFD700';
  ctx.beginPath(); ctx.arc(w*0.82,h*0.12,w*0.07,0,Math.PI*2); ctx.fill();
  drawCloud(ctx,w*0.2,h*0.1,w*0.09);
}

function drawFish(ctx, w, h){
  // Underwater gradient
  const sea=ctx.createLinearGradient(0,0,0,h);
  sea.addColorStop(0,'#006994'); sea.addColorStop(1,'#003355');
  ctx.fillStyle=sea; ctx.fillRect(0,0,w,h);
  // Bubbles
  ctx.strokeStyle='rgba(255,255,255,.4)'; ctx.lineWidth=1.5;
  [[0.2,0.15],[0.75,0.25],[0.5,0.08],[0.85,0.4]].forEach(([x,y])=>{
    ctx.beginPath(); ctx.arc(w*x,h*y,w*0.03,0,Math.PI*2); ctx.stroke();
  });
  // Seaweed
  ctx.strokeStyle='#2E8B57'; ctx.lineWidth=5;
  [[0.12,0.2],[0.88,0.15]].forEach(([x,sw])=>{
    ctx.beginPath();
    ctx.moveTo(w*x,h);
    for(let i=0;i<6;i++) ctx.quadraticCurveTo(w*(x+(i%2?0.06:-0.06)),h*(1-i*0.15),w*x,h*(0.85-i*0.15));
    ctx.stroke();
  });
  // Fish body
  ctx.fillStyle='#FF7043';
  ctx.beginPath(); ctx.ellipse(w*0.5,h*0.5,w*0.3,h*0.18,0,0,Math.PI*2); ctx.fill();
  // Scales
  ctx.strokeStyle='#E64A19'; ctx.lineWidth=1;
  for(let i=0;i<3;i++) for(let j=0;j<2;j++){
    ctx.beginPath();
    ctx.arc(w*(0.38+i*0.09),h*(0.45+j*0.08),w*0.05,Math.PI,Math.PI*2);
    ctx.stroke();
  }
  // Tail
  ctx.fillStyle='#FF8A65';
  ctx.beginPath(); ctx.moveTo(w*0.2,h*0.5); ctx.lineTo(w*0.05,h*0.35); ctx.lineTo(w*0.05,h*0.65); ctx.fill();
  // Eye
  ctx.fillStyle='white';
  ctx.beginPath(); ctx.arc(w*0.66,h*0.46,w*0.05,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#111';
  ctx.beginPath(); ctx.arc(w*0.67,h*0.46,w*0.025,0,Math.PI*2); ctx.fill();
  // Fin top
  ctx.fillStyle='#FF8A65';
  ctx.beginPath(); ctx.moveTo(w*0.45,h*0.33); ctx.quadraticCurveTo(w*0.52,h*0.22,w*0.6,h*0.34); ctx.lineTo(w*0.55,h*0.37); ctx.fill();
  // Sand bottom
  ctx.fillStyle='#C2A07A';
  ctx.fillRect(0,h*0.85,w,h*0.15);
  // Pebbles
  ctx.fillStyle='#A0876A';
  [[0.1,0.88],[0.3,0.9],[0.6,0.87],[0.8,0.91]].forEach(([x,y])=>{
    ctx.beginPath(); ctx.ellipse(w*x,h*y,w*0.05,h*0.025,0,0,Math.PI*2); ctx.fill();
  });
}

function drawNight(ctx, w, h){
  const sky=ctx.createLinearGradient(0,0,0,h*0.75);
  sky.addColorStop(0,'#0D1B4B'); sky.addColorStop(1,'#1A237E');
  ctx.fillStyle=sky; ctx.fillRect(0,0,w,h*0.75);
  // Stars
  ctx.fillStyle='#FFF';
  for(let i=0;i<40;i++){
    const x=Math.random()*w, y=Math.random()*h*0.65;
    const s=Math.random()*2.5+0.5;
    ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill();
  }
  // Moon
  ctx.fillStyle='#FFF9C4';
  ctx.beginPath(); ctx.arc(w*0.78,h*0.15,w*0.1,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#1A237E';
  ctx.beginPath(); ctx.arc(w*0.84,h*0.13,w*0.09,0,Math.PI*2); ctx.fill();
  // Ground
  ctx.fillStyle='#1B5E20'; ctx.fillRect(0,h*0.75,w,h*0.25);
  // Hills
  ctx.fillStyle='#2E7D32';
  ctx.beginPath(); ctx.arc(w*0.2,h*0.75,w*0.28,0,Math.PI,true); ctx.fill();
  ctx.beginPath(); ctx.arc(w*0.75,h*0.75,w*0.22,0,Math.PI,true); ctx.fill();
  // Trees
  [[0.1,0.6],[0.9,0.55]].forEach(([x,y])=>{
    ctx.fillStyle='#4CAF50';
    ctx.beginPath(); ctx.arc(w*x,h*y,w*0.1,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#795548';
    ctx.fillRect(w*x-w*0.02,h*(y+0.1),w*0.04,h*0.1);
  });
}

function drawButterfly(ctx, w, h){
  const bg=ctx.createLinearGradient(0,0,w,h);
  bg.addColorStop(0,'#E8F5E9'); bg.addColorStop(1,'#F3E5F5');
  ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
  // Flowers in bg
  [[0.1,0.8],[0.85,0.75],[0.5,0.85],[0.25,0.9],[0.7,0.88]].forEach(([x,y])=>{
    ctx.fillStyle='#FFB300';
    ctx.beginPath(); ctx.arc(w*x,h*y,w*0.04,0,Math.PI*2); ctx.fill();
    ['#E91E63','#FF7043','#9C27B0'].forEach((c,i)=>{
      ctx.fillStyle=c;
      ctx.beginPath();
      const a=i/3*Math.PI*2;
      ctx.ellipse(w*x+Math.cos(a)*w*0.06,h*y+Math.sin(a)*h*0.06,w*0.04,h*0.025,a,0,Math.PI*2);
      ctx.fill();
    });
  });
  // Wings
  const wingColors=[['#FF9800','#F57C00'],['#FF5722','#E64A19']];
  // Top wings
  [[0.32,0.42,-0.5,1],[0.68,0.42,0.5,1]].forEach(([cx,cy,rot,s],i)=>{
    ctx.fillStyle=wingColors[0][0];
    ctx.save(); ctx.translate(w*cx,h*cy); ctx.rotate(rot);
    ctx.beginPath(); ctx.ellipse(0,0,w*0.22,h*0.22,0,0,Math.PI*2); ctx.fill();
    // Pattern
    ctx.fillStyle=wingColors[0][1];
    ctx.beginPath(); ctx.arc(w*(i?0.06:-0.06),0,w*0.07,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });
  // Bottom wings
  [[0.35,0.62,-0.3,1],[0.65,0.62,0.3,1]].forEach(([cx,cy,rot])=>{
    ctx.fillStyle=wingColors[1][0];
    ctx.save(); ctx.translate(w*cx,h*cy); ctx.rotate(rot);
    ctx.beginPath(); ctx.ellipse(0,0,w*0.18,h*0.15,0,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });
  // Body
  ctx.fillStyle='#3E2723';
  ctx.beginPath(); ctx.ellipse(w/2,h*0.52,w*0.04,h*0.22,0,0,Math.PI*2); ctx.fill();
  // Head
  ctx.fillStyle='#4E342E';
  ctx.beginPath(); ctx.arc(w/2,h*0.3,w*0.05,0,Math.PI*2); ctx.fill();
  // Antennae
  ctx.strokeStyle='#4E342E'; ctx.lineWidth=2;
  [[-0.06,-0.08],[0.06,-0.08]].forEach(([dx,dy])=>{
    ctx.beginPath(); ctx.moveTo(w/2,h*0.3);
    ctx.quadraticCurveTo(w*(0.5+dx*2),h*0.18,w*(0.5+dx),h*0.14); ctx.stroke();
    ctx.fillStyle='#FF9800';
    ctx.beginPath(); ctx.arc(w*(0.5+dx),h*0.14,w*0.02,0,Math.PI*2); ctx.fill();
  });
}

function drawApple(ctx, w, h){
  const bg=ctx.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,'#E8F5E9'); bg.addColorStop(1,'#C8E6C9');
  ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
  // Leaf
  ctx.fillStyle='#388E3C';
  ctx.beginPath();
  ctx.moveTo(w/2,h*0.18);
  ctx.quadraticCurveTo(w*0.68,h*0.06,w*0.72,h*0.22);
  ctx.quadraticCurveTo(w*0.6,h*0.28,w/2,h*0.18);
  ctx.fill();
  ctx.strokeStyle='#2E7D32'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(w/2,h*0.18); ctx.lineTo(w*0.65,h*0.18); ctx.stroke();
  // Stem
  ctx.strokeStyle='#5D4037'; ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(w*0.5,h*0.25); ctx.quadraticCurveTo(w*0.55,h*0.18,w*0.52,h*0.14); ctx.stroke();
  // Apple body
  const grad=ctx.createRadialGradient(w*0.42,h*0.4,w*0.02,w/2,h*0.55,w*0.38);
  grad.addColorStop(0,'#FF5252'); grad.addColorStop(0.6,'#F44336'); grad.addColorStop(1,'#B71C1C');
  ctx.fillStyle=grad;
  ctx.beginPath();
  ctx.moveTo(w/2,h*0.26);
  ctx.bezierCurveTo(w*0.22,h*0.26,w*0.12,h*0.45,w*0.15,h*0.62);
  ctx.bezierCurveTo(w*0.18,h*0.82,w*0.35,h*0.88,w*0.5,h*0.88);
  ctx.bezierCurveTo(w*0.65,h*0.88,w*0.82,h*0.82,w*0.85,h*0.62);
  ctx.bezierCurveTo(w*0.88,h*0.45,w*0.78,h*0.26,w*0.5,h*0.26);
  ctx.fill();
  // Shine
  ctx.fillStyle='rgba(255,255,255,.35)';
  ctx.beginPath(); ctx.ellipse(w*0.38,h*0.42,w*0.1,h*0.07,-0.4,0,Math.PI*2); ctx.fill();
}

function drawRocket(ctx, w, h){
  // Space bg
  ctx.fillStyle='#0D0A2A'; ctx.fillRect(0,0,w,h);
  // Stars
  ctx.fillStyle='white';
  for(let i=0;i<50;i++){
    ctx.beginPath(); ctx.arc(Math.random()*w,Math.random()*h,Math.random()*1.5+0.3,0,Math.PI*2); ctx.fill();
  }
  // Planet
  ctx.fillStyle='#7986CB';
  ctx.beginPath(); ctx.arc(w*0.82,h*0.2,w*0.1,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#9FA8DA'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.ellipse(w*0.82,h*0.2,w*0.17,h*0.04,0.3,0,Math.PI*2); ctx.stroke();
  // Flame
  [[0,'#FF6D00',0.18],[0.04,'#FFD600',0.12],[-0.04,'#FF9100',0.14]].forEach(([dx,c,s])=>{
    const fg=ctx.createRadialGradient(w*(0.5+dx),h*0.85,0,w*(0.5+dx),h*0.85,w*s);
    fg.addColorStop(0,c); fg.addColorStop(1,'transparent');
    ctx.fillStyle=fg; ctx.beginPath(); ctx.arc(w*(0.5+dx),h*0.85,w*s,0,Math.PI*2); ctx.fill();
  });
  // Body
  const rg=ctx.createLinearGradient(w*0.35,0,w*0.65,0);
  rg.addColorStop(0,'#B0BEC5'); rg.addColorStop(0.5,'#ECEFF1'); rg.addColorStop(1,'#B0BEC5');
  ctx.fillStyle=rg;
  rrect(ctx,w*0.38,h*0.38,w*0.24,h*0.42,8); ctx.fill;
  // Nose cone
  ctx.fillStyle='#EF5350';
  ctx.beginPath(); ctx.moveTo(w*0.38,h*0.38); ctx.lineTo(w/2,h*0.18); ctx.lineTo(w*0.62,h*0.38); ctx.fill();
  // Window
  ctx.fillStyle='#81D4FA';
  ctx.beginPath(); ctx.arc(w/2,h*0.51,w*0.08,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#29B6F6'; ctx.lineWidth=2; ctx.stroke();
  // Wings
  ctx.fillStyle='#EF5350';
  ctx.beginPath(); ctx.moveTo(w*0.38,h*0.7); ctx.lineTo(w*0.2,h*0.82); ctx.lineTo(w*0.38,h*0.8); ctx.fill();
  ctx.beginPath(); ctx.moveTo(w*0.62,h*0.7); ctx.lineTo(w*0.8,h*0.82); ctx.lineTo(w*0.62,h*0.8); ctx.fill();
}


// ================================================================
// UMETALJKA ‚Äî sorter igra, vuci broj/slovo/oblik u siluetu
// Svaki level = jedna lijepa scena + siluete lebde u sceni
// ================================================================

// Level config: scene background + shapes/numbers to match
const UMET_LEVELS = [
  { scene:'zima',   items:[{key:'1',type:'broj'}] },
  { scene:'more',   items:[{key:'2',type:'broj'},{key:'3',type:'broj'}] },
  { scene:'svemirx',items:[{key:'4',type:'broj'},{key:'5',type:'broj'}] },
  { scene:'sume',   items:[{key:'A',type:'slovo'}] },
  { scene:'grad',   items:[{key:'B',type:'slovo'},{key:'C',type:'slovo'}] },
  { scene:'zima',   items:[{key:'6',type:'broj'},{key:'7',type:'broj'}] },
  { scene:'more',   items:[{key:'‚ñ†',type:'oblik'},{key:'‚ñ≤',type:'oblik'}] },
  { scene:'svemirx',items:[{key:'‚óè',type:'oblik'},{key:'‚ñ†',type:'oblik'},{key:'‚ñ≤',type:'oblik'}] },
  { scene:'sume',   items:[{key:'8',type:'broj'},{key:'9',type:'broj'}] },
  { scene:'grad',   items:[{key:'‚óè',type:'oblik'},{key:'A',type:'slovo'},{key:'5',type:'broj'}] },
];

// Wrong decoys pool
const UMET_DECOYS = {
  broj:  ['1','2','3','4','5','6','7','8','9'],
  slovo: ['A','B','C','D','G','J','K','L'],
  oblik: ['‚óè','‚ñ†','‚ñ≤'],
};

// Colors for each key
const UMET_KEY_COLOR = {
  '1':'#FF6B9D','2':'#3B82F6','3':'#F97316','4':'#10B981','5':'#A855F7',
  '6':'#FBBF24','7':'#EC4899','8':'#06B6D4','9':'#84CC16',
  'A':'#FF6B9D','B':'#F97316','C':'#FBBF24','D':'#10B981','G':'#3B82F6','J':'#A855F7',
  '‚óè':'#FF6B9D','‚ñ†':'#3B82F6','‚ñ≤':'#FBBF24',
};
function umetCol(k){ return UMET_KEY_COLOR[k]||'#A855F7'; }

// Slot positions per scene + item count
// Returns [{x,y,w,h}] ‚Äî positions in 600√ó480 canvas space
function getUmetSlotPositions(scene, n){
  const base = {
    zima:   [{x:220,y:120},{x:370,y:100},{x:160,y:180}],
    more:   [{x:200,y:110},{x:380,y:130},{x:290,y:80}],
    svemirx:[{x:230,y:95}, {x:380,y:110},{x:160,y:155}],
    sume:   [{x:280,y:100},{x:150,y:130},{x:410,y:120}],
    grad:   [{x:200,y:105},{x:360,y:95}, {x:290,y:160}],
  };
  return (base[scene]||base.zima).slice(0,n);
}

let umetCtx=null, umetCanvas=null;
let umetSlots=[];     // [{key,x,y,w,h,filled,el}]
let umetPlaced2=0, umetDragKey=null, umetDragEl=null;
const UMET_SW=85, UMET_SH=95; // slot width/height

function startUmetaljka(lvl){
  LVL=lvl;
  umetPlaced2=0; umetDragKey=null; umetDragEl=null; umetSlots=[];

  const cfg=UMET_LEVELS[lvl-1];
  document.getElementById('umet-level-lbl').textContent=`Level ${lvl}`;
  document.getElementById('umet-prog-bar').style.width='0%';

  const keyNames=cfg.items.map(i=>i.key).join(', ');
  document.getElementById('umet-task-label').textContent=`Ubaci: ${keyNames}`;

  umetCanvas=document.getElementById('umet-scene-canvas');
  umetCtx=umetCanvas.getContext('2d');

  // Canvas: full width, height proportional (600x480 ratio), capped so tray fits
  const actualW = Math.min(window.innerWidth, 700);
  const actualH = Math.min(Math.round(actualW * 480/600), window.innerHeight - 200);
  umetCanvas.width  = 600;
  umetCanvas.height = 480;
  umetCanvas.style.width  = actualW + 'px';
  umetCanvas.style.height = actualH + 'px';

  drawUmetBg(cfg.scene, actualW, actualH);

  // Build slots layer
  const layer=document.getElementById('umet-slots-layer');
  layer.innerHTML='';
  layer.style.cssText=`position:absolute;top:0;left:0;
    width:${actualW}px;height:${actualH}px;pointer-events:none;z-index:5;`;

  const positions=getUmetSlotPositions(cfg.scene, cfg.items.length);
  const scaleX=actualW/600, scaleY=actualH/480;

  cfg.items.forEach((item,i)=>{
    const pos=positions[i];
    const sx=pos.x*scaleX, sy=pos.y*scaleY;
    const sw=UMET_SW*scaleX, sh=UMET_SH*scaleY;
    const col=umetCol(item.key);

    // Draw silhouette on canvas
    drawUmetSilhouette(pos.x, pos.y, UMET_SW, UMET_SH, item.key, col, false);

    // Invisible drop div (pointer-events on)
    const div=document.createElement('div');
    div.dataset.key=item.key;
    div.className='umet-slot';
    div.style.cssText=`position:absolute;left:${sx-sw/2}px;top:${sy-sh/2}px;
      width:${sw}px;height:${sh}px;pointer-events:all;border-radius:16px;cursor:default;`;
    setupUmetSlot(div);
    layer.appendChild(div);

    umetSlots.push({key:item.key,x:pos.x,y:pos.y,el:div,filled:false,col,
      cx:pos.x, cy:pos.y, sw:UMET_SW, sh:UMET_SH, scaleX, scaleY});
  });

  buildUmetPieces2(cfg);
  showScreen('screen-umetaljka');
}

// Draw beautiful scene backgrounds on canvas
function drawUmetBg(scene, W=600, H=480){
  const ctx=umetCtx;
  ctx.clearRect(0,0,W,H);

  if(scene==='zima'){
    // Sky gradient
    const sky=ctx.createLinearGradient(0,0,0,H*0.65);
    sky.addColorStop(0,'#1de9b6'); sky.addColorStop(1,'#4fc3f7');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H*0.65);
    // Mountains back
    ctx.fillStyle='#b0bec5';
    ctx.beginPath(); ctx.moveTo(0,300); ctx.lineTo(120,150); ctx.lineTo(240,300); ctx.fill();
    ctx.beginPath(); ctx.moveTo(200,300); ctx.lineTo(360,120); ctx.lineTo(520,300); ctx.fill();
    ctx.beginPath(); ctx.moveTo(400,300); ctx.lineTo(550,170); ctx.lineTo(700,300); ctx.fill();
    // Snow on mountains
    ctx.fillStyle='white';
    ctx.beginPath(); ctx.moveTo(120,150); ctx.lineTo(95,210); ctx.lineTo(145,210); ctx.fill();
    ctx.beginPath(); ctx.moveTo(360,120); ctx.lineTo(325,195); ctx.lineTo(395,195); ctx.fill();
    ctx.beginPath(); ctx.moveTo(550,170); ctx.lineTo(520,230); ctx.lineTo(580,230); ctx.fill();
    // Snow ground
    const snow=ctx.createLinearGradient(0,300,0,H);
    snow.addColorStop(0,'#e3f2fd'); snow.addColorStop(1,'#bbdefb');
    ctx.fillStyle=snow; ctx.fillRect(0,300,W,H);
    // Snow hill
    ctx.fillStyle='#e8f5e9';
    ctx.beginPath(); ctx.arc(160,420,240,Math.PI,0); ctx.fill();
    // Trees
    [[60,330],[100,310],[140,340],[460,315],[500,335],[540,310]].forEach(([x,y])=>{
      ctx.fillStyle='#2e7d32';
      ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x-22,y+55); ctx.lineTo(x+22,y+55); ctx.fill();
      ctx.beginPath(); ctx.moveTo(x,y+20); ctx.lineTo(x-28,y+70); ctx.lineTo(x+28,y+70); ctx.fill();
      ctx.fillStyle='#795548'; ctx.fillRect(x-7,y+68,14,22);
    });
    // Snowflakes
    ctx.fillStyle='white';
    for(let i=0;i<35;i++){
      const sx=((i*173)%W), sy=((i*97)%H);
      ctx.beginPath(); ctx.arc(sx,sy,i%4+1.5,0,Math.PI*2); ctx.fill();
    }
    // Sun
    ctx.fillStyle='#FFD700';
    ctx.beginPath(); ctx.arc(545,45,34,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#FFD700'; ctx.lineWidth=3;
    for(let i=0;i<8;i++){
      const a=i/8*Math.PI*2;
      ctx.beginPath(); ctx.moveTo(545+42*Math.cos(a),45+42*Math.sin(a));
      ctx.lineTo(545+54*Math.cos(a),45+54*Math.sin(a)); ctx.stroke();
    }

  } else if(scene==='more'){
    // Sky
    const sky=ctx.createLinearGradient(0,0,0,H*0.5);
    sky.addColorStop(0,'#0288d1'); sky.addColorStop(1,'#4fc3f7');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H*0.5);
    // Clouds
    [[80,55,50],[200,35,40],[380,60,45],[500,42,38]].forEach(([cx,cy,r])=>{
      ctx.fillStyle='white';
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(cx-r*0.6,cy+r*0.2,r*0.7,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(cx+r*0.6,cy+r*0.2,r*0.7,0,Math.PI*2); ctx.fill();
    });
    // Sun
    ctx.fillStyle='#FFD700';
    ctx.beginPath(); ctx.arc(550,50,32,0,Math.PI*2); ctx.fill();
    // Water
    const sea=ctx.createLinearGradient(0,H*0.5,0,H);
    sea.addColorStop(0,'#0277bd'); sea.addColorStop(1,'#01579b');
    ctx.fillStyle=sea; ctx.fillRect(0,H*0.5,W,H*0.5);
    // Waves
    ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=3;
    for(let wy=0;wy<4;wy++){
      ctx.beginPath();
      for(let wx=0;wx<=W;wx+=30){
        ctx.lineTo(wx, H*0.5+wy*55+20*Math.sin(wx/40+wy));
      }
      ctx.stroke();
    }
    // Boat
    ctx.fillStyle='#e53935';
    ctx.beginPath(); ctx.moveTo(180,245); ctx.lineTo(160,295); ctx.lineTo(360,295); ctx.lineTo(340,245); ctx.fill();
    ctx.fillStyle='#fff9c4'; ctx.fillRect(200,195,140,52);
    ctx.fillStyle='#795548'; ctx.fillRect(264,130,8,68);
    ctx.fillStyle='#ff5722';
    ctx.beginPath(); ctx.moveTo(272,135); ctx.lineTo(310,155); ctx.lineTo(272,175); ctx.fill();
    // Fish visible through water
    ctx.fillStyle='rgba(255,152,0,.6)';
    ctx.beginPath(); ctx.ellipse(120,390,35,18,0.3,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,152,0,.6)';
    ctx.beginPath(); ctx.moveTo(85,390); ctx.lineTo(65,375); ctx.lineTo(65,405); ctx.fill();

  } else if(scene==='svemirx'){
    // Deep space
    ctx.fillStyle='#080420'; ctx.fillRect(0,0,W,H);
    // Stars
    for(let i=0;i<120;i++){
      const sx=((i*179+31)%W), sy=((i*113+17)%H);
      const sr=i%8===0?2:i%4===0?1.5:0.8;
      ctx.fillStyle=`rgba(255,255,255,${0.4+i%3*0.2})`;
      ctx.beginPath(); ctx.arc(sx,sy,sr,0,Math.PI*2); ctx.fill();
    }
    // Nebula glow
    const neb=ctx.createRadialGradient(480,360,20,480,360,160);
    neb.addColorStop(0,'rgba(168,85,247,.18)'); neb.addColorStop(1,'transparent');
    ctx.fillStyle=neb; ctx.fillRect(0,0,W,H);
    // Planet 1
    ctx.fillStyle='#7986cb';
    ctx.beginPath(); ctx.arc(490,85,55,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#9fa8da'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.ellipse(490,85,80,20,0.2,0,Math.PI*2); ctx.stroke();
    // Planet 2 small
    ctx.fillStyle='#ef9a9a';
    ctx.beginPath(); ctx.arc(100,380,32,0,Math.PI*2); ctx.fill();
    // Rocket
    ctx.fillStyle='#eceff1'; ctx.beginPath();
    rrect(ctx,65,200,60,130,10); ctx.fill();
    ctx.fillStyle='#ef5350';
    ctx.beginPath(); ctx.moveTo(65,205); ctx.lineTo(95,140); ctx.lineTo(125,205); ctx.fill();
    ctx.fillStyle='#ef5350';
    ctx.beginPath(); ctx.moveTo(65,285); ctx.lineTo(45,325); ctx.lineTo(65,315); ctx.fill();
    ctx.beginPath(); ctx.moveTo(125,285); ctx.lineTo(145,325); ctx.lineTo(125,315); ctx.fill();
    ctx.fillStyle='#81d4fa'; ctx.beginPath(); ctx.arc(95,240,18,0,Math.PI*2); ctx.fill();
    // Flame
    const fl=ctx.createRadialGradient(95,335,2,95,335,28);
    fl.addColorStop(0,'#FFD600'); fl.addColorStop(0.6,'#FF6D00'); fl.addColorStop(1,'transparent');
    ctx.fillStyle=fl; ctx.beginPath(); ctx.arc(95,335,28,0,Math.PI*2); ctx.fill();

  } else if(scene==='sume'){
    // Forest scene
    const sky=ctx.createLinearGradient(0,0,0,H*0.55);
    sky.addColorStop(0,'#1b5e20'); sky.addColorStop(1,'#4caf50');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H*0.55);
    // Sun rays
    ctx.fillStyle='rgba(255,220,0,.15)';
    for(let i=0;i<12;i++){
      const a=i/12*Math.PI*2;
      ctx.beginPath(); ctx.moveTo(300,0);
      ctx.lineTo(300+300*Math.cos(a-0.15),300*Math.sin(a));
      ctx.lineTo(300+300*Math.cos(a+0.15),300*Math.sin(a));
      ctx.fill();
    }
    ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(300,0,40,0,Math.PI*2); ctx.fill();
    // Ground
    ctx.fillStyle='#33691e'; ctx.fillRect(0,H*0.55,W,H*0.45);
    // Grass details
    ctx.fillStyle='#558b2f';
    for(let gx=0;gx<W;gx+=20){
      ctx.fillRect(gx,H*0.55-8,10,16);
    }
    // Big trees
    [[80,50,280],[200,45,260],[420,55,265],[540,48,270]].forEach(([x,r,y])=>{
      ctx.fillStyle='#1b5e20';
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#2e7d32';
      ctx.beginPath(); ctx.arc(x-r*0.2,y-r*0.2,r*0.85,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#5d4037'; ctx.fillRect(x-10,y+r-10,20,60);
    });
    // Flowers
    [[150,300],[300,310],[450,295]].forEach(([fx,fy])=>{
      ['#FF6B9D','#FFD700','#FF5722'].forEach((c,ci)=>{
        ctx.fillStyle=c;
        ctx.beginPath(); ctx.arc(fx+ci*15,fy,8,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#FFD700';
        ctx.beginPath(); ctx.arc(fx+ci*15,fy,3,0,Math.PI*2); ctx.fill();
      });
    });

  } else { // grad
    const sky=ctx.createLinearGradient(0,0,0,H*0.6);
    sky.addColorStop(0,'#ff6f00'); sky.addColorStop(0.5,'#ff8f00'); sky.addColorStop(1,'#ffca28');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H*0.6);
    // Sun setting
    ctx.fillStyle='#FFD700';
    ctx.beginPath(); ctx.arc(300,H*0.6,55,Math.PI,0); ctx.fill();
    // Buildings silhouette
    const buildings=[[0,200,90,280],[90,240,70,240],[160,170,100,310],[260,220,80,260],
                     [340,185,90,295],[430,240,70,240],[500,200,100,280]];
    ctx.fillStyle='#1a237e';
    buildings.forEach(([x,y,w,h])=>{
      ctx.fillRect(x,y,w,h);
      // Windows
      ctx.fillStyle='#ffca28';
      for(let wy=y+15;wy<y+h-20;wy+=25){
        for(let wx=x+10;wx<x+w-10;wx+=18){
          if(Math.random()>0.3) ctx.fillRect(wx,wy,10,12);
        }
      }
      ctx.fillStyle='#1a237e';
    });
    // Road
    ctx.fillStyle='#37474f'; ctx.fillRect(0,H*0.78,W,H*0.22);
    ctx.fillStyle='#ffca28';
    for(let rx=0;rx<W;rx+=50) ctx.fillRect(rx,H*0.88,30,8);
    // Street lights
    [[100,390],[250,390],[400,390],[550,390]].forEach(([lx,ly])=>{
      ctx.strokeStyle='#607d8b'; ctx.lineWidth=4;
      ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(lx,ly-80); ctx.lineTo(lx+20,ly-80); ctx.stroke();
      ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(lx+20,ly-80,8,0,Math.PI*2); ctx.fill();
    });
  }
}

function drawUmetSilhouette(cx, cy, sw, sh, key, col, filled){
  const ctx=umetCtx;
  ctx.save();

  if(filled){
    // Filled ‚Äî bright piece dropped in
    const grad=ctx.createRadialGradient(cx,cy,4,cx,cy,sw*0.6);
    grad.addColorStop(0,col); grad.addColorStop(1,col+'99');
    ctx.fillStyle=grad;
    ctx.shadowColor=col; ctx.shadowBlur=20;
  } else {
    // Empty ‚Äî dark hole with glowing outline
    ctx.fillStyle='rgba(0,0,0,.55)';
    ctx.shadowColor=col; ctx.shadowBlur=16;
  }

  const x=cx-sw/2, y=cy-sh/2;

  // Draw shape based on key type
  if(key==='‚óè'){
    ctx.beginPath(); ctx.arc(cx,cy,Math.min(sw,sh)*0.48,0,Math.PI*2);
    ctx.fill();
    if(!filled){
      ctx.strokeStyle=col; ctx.lineWidth=4;
      ctx.setLineDash([8,5]); ctx.stroke(); ctx.setLineDash([]);
    }
  } else if(key==='‚ñ≤'){
    ctx.beginPath();
    ctx.moveTo(cx, y+8); ctx.lineTo(x+8, y+sh-8); ctx.lineTo(x+sw-8, y+sh-8); ctx.closePath();
    ctx.fill();
    if(!filled){
      ctx.strokeStyle=col; ctx.lineWidth=4; ctx.setLineDash([8,5]); ctx.stroke(); ctx.setLineDash([]);
    }
  } else if(key==='‚ñ†'){
    const r=14;
    rrect(ctx, x+8, y+8, sw-16, sh-16, r); ctx.fill();
    if(!filled){
      ctx.strokeStyle=col; ctx.lineWidth=4; ctx.setLineDash([8,5]); ctx.stroke(); ctx.setLineDash([]);
    }
  } else {
    // Number or letter ‚Äî rounded rect background + text
    rrect(ctx, x+4, y+4, sw-8, sh-8, 14); ctx.fill();
    if(!filled){
      ctx.strokeStyle=col; ctx.lineWidth=4; ctx.setLineDash([8,5]); ctx.stroke(); ctx.setLineDash([]);
      // Ghost number
      ctx.fillStyle=col+'55';
      ctx.font=`bold ${Math.round(sh*0.55)}px 'Fredoka One', cursive`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(key, cx, cy+2);
    } else {
      ctx.fillStyle='white';
      ctx.shadowColor='rgba(0,0,0,.4)'; ctx.shadowBlur=8;
      ctx.font=`bold ${Math.round(sh*0.55)}px 'Fredoka One', cursive`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(key, cx, cy+2);
    }
  }

  ctx.restore();
}

function buildUmetPieces2(cfg){
  const tray=document.getElementById('umet-tray');
  tray.innerHTML='';

  // Collect all keys needed
  const needed=cfg.items.map(i=>i.key);
  // Build decoy pool ‚Äî wrong items same type
  const decoys=[];
  cfg.items.forEach(item=>{
    const pool=UMET_DECOYS[item.type].filter(k=>!needed.includes(k));
    decoys.push(...pool.sort(()=>Math.random()-.5).slice(0,1));
  });

  const all=[...needed,...decoys].sort(()=>Math.random()-.5);
  const PIECE_SIZE=72;

  all.forEach(key=>{
    const col=umetCol(key);
    const cv=document.createElement('canvas');
    cv.width=PIECE_SIZE; cv.height=PIECE_SIZE;
    cv.className='umet-piece';
    cv.dataset.key=key;
    cv.style.width=PIECE_SIZE+'px'; cv.style.height=PIECE_SIZE+'px';
    cv.style.background=`linear-gradient(135deg,${col}dd,${col}88)`;

    // Draw piece content on canvas
    const pctx=cv.getContext('2d');
    pctx.fillStyle='white';
    if(key==='‚óè'){
      pctx.beginPath(); pctx.arc(36,36,26,0,Math.PI*2); pctx.fill();
    } else if(key==='‚ñ≤'){
      pctx.beginPath(); pctx.moveTo(36,8); pctx.lineTo(8,62); pctx.lineTo(64,62); pctx.closePath(); pctx.fill();
    } else if(key==='‚ñ†'){
      rrect(pctx,10,10,52,52,10); pctx.fill();
    } else {
      pctx.shadowColor='rgba(0,0,0,.3)'; pctx.shadowBlur=6;
      pctx.font='bold 38px "Fredoka One",cursive';
      pctx.textAlign='center'; pctx.textBaseline='middle';
      pctx.fillText(key,36,38);
    }

    setupUmetPiece(cv);
    tray.appendChild(cv);
  });
}

function setupUmetPiece(el){
  el.draggable=true;
  el.addEventListener('dragstart', e=>{
    umetDragKey=el.dataset.key; umetDragEl=el;
    el.classList.add('dragging-piece');
    e.dataTransfer.setData('text/plain',el.dataset.key);
  });
  el.addEventListener('dragend',()=>el.classList.remove('dragging-piece'));

  let ghost=null;
  el.addEventListener('touchstart', e=>{
    umetDragKey=el.dataset.key; umetDragEl=el;
    const t=e.touches[0];
    ghost=el.cloneNode(true);
    const sz=+el.style.width.replace('px','')||72;
    ghost.style.cssText=`position:fixed;width:${sz}px;height:${sz}px;opacity:.9;pointer-events:none;z-index:999;
      border-radius:16px;left:${t.clientX-sz/2}px;top:${t.clientY-sz/2}px;
      box-shadow:0 12px 32px rgba(0,0,0,.5);animation:none;`;
    document.body.appendChild(ghost);
    el.style.opacity='.25';
  },{passive:true});
  el.addEventListener('touchmove', e=>{
    if(!ghost) return;
    const t=e.touches[0], sz=+ghost.style.width.replace('px','')||72;
    ghost.style.left=(t.clientX-sz/2)+'px'; ghost.style.top=(t.clientY-sz/2)+'px';
    e.preventDefault();
  },{passive:false});
  el.addEventListener('touchend', e=>{
    if(ghost){ghost.remove();ghost=null;} el.style.opacity='';
    const t=e.changedTouches[0];
    const hit=document.elementFromPoint(t.clientX,t.clientY);
    const slot=hit&&hit.closest('.umet-slot');
    if(slot) dropOnUmetSlot(slot);
    else{umetDragKey=null;umetDragEl=null;}
  });
}

function setupUmetSlot(slot){
  slot.addEventListener('dragover', e=>{
    e.preventDefault();
    if(!slot.dataset.filled) slot.classList.add('slot-over-glow');
  });
  slot.addEventListener('dragleave',()=>slot.classList.remove('slot-over-glow'));
  slot.addEventListener('drop', e=>{
    e.preventDefault(); slot.classList.remove('slot-over-glow');
    dropOnUmetSlot(slot);
  });
}

function dropOnUmetSlot(slot){
  if(!umetDragKey||!umetDragEl) return;
  if(slot.dataset.filled) return;

  if(umetDragKey===slot.dataset.key){
    // CORRECT ‚Äî find slot info and draw filled silhouette
    const slotInfo=umetSlots.find(s=>s.key===slot.dataset.key&&!s.filled);
    if(slotInfo){
      slotInfo.filled=true;
      slot.dataset.filled='1';
      // Redraw bg to clean up
      drawUmetBg(UMET_LEVELS[LVL-1].scene, umetCanvas.width, umetCanvas.height);
      // Redraw all silhouettes
      umetSlots.forEach(s=>{
        drawUmetSilhouette(s.cx,s.cy,s.sw,s.sh,s.key,s.col,s.filled);
      });
    }
    umetDragEl.remove();
    playCorrect();
    umetPlaced2++;
    document.getElementById('umet-prog-bar').style.width=(umetPlaced2/UMET_LEVELS[LVL-1].items.length*100)+'%';
    document.getElementById('umet-task-label').textContent=
      umetPlaced2<UMET_LEVELS[LVL-1].items.length ? 'üéØ Jo≈° malo!' : 'üéâ Bravo!';

    if(umetPlaced2>=UMET_LEVELS[LVL-1].items.length) setTimeout(umetDone,700);
  } else {
    playWrong();
    // Shake animation on slot
    const s=umetSlots.find(ss=>ss.key===slot.dataset.key);
    if(s){
      let t=0;
      const shake=setInterval(()=>{
        const off=t%2===0?6:-6;
        // Brief redraw offset ‚Äî just flash the slot glow red
        slot.style.outline=`3px solid #EF5350`;
        t++;
        if(t>4){clearInterval(shake);slot.style.outline='';}
      },80);
    }
  }
  umetDragKey=null; umetDragEl=null;
}

function umetDone(){
  completed['umetaljka'].add(LVL);
  confetti(); setTimeout(playWin,200); setTimeout(()=>speak('Bravo!'),600);
  setTimeout(()=>{
    document.getElementById('res-emoji').textContent='üéØ';
    document.getElementById('res-title').textContent='Sve si slo≈æio!';
    document.getElementById('res-sub').textContent=`Level ${LVL} zavr≈°en!`;
    document.getElementById('res-stars').innerHTML='‚≠ê‚≠ê‚≠ê';
    document.getElementById('next-lvl-btn').style.display=LVL<10?'':'none';
    document.getElementById('result-overlay').classList.add('show');
  },1300);
}


// ================================================================
// GOVORIMO ‚Äî uƒçenje prvih rijeƒçi za djecu 2-3 godine
// 20 levela, svaki = jedna nova rijeƒç s velikom slikom
// ================================================================

const GOVOR_RIJECI = [
  // ≈Ωivotinje
  { e:'üê∂', r:'PAS',     s:'P ¬∑ A ¬∑ S',     kat:'≈Ωivotinje',  boja:'#FF6B9D' },
  { e:'üê±', r:'MAƒåKA',   s:'MAƒå ¬∑ KA',       kat:'≈Ωivotinje',  boja:'#F97316' },
  { e:'üêÑ', r:'KRAVA',   s:'KRA ¬∑ VA',       kat:'≈Ωivotinje',  boja:'#FBBF24' },
  { e:'üê∏', r:'≈ΩABA',    s:'≈ΩA ¬∑ BA',        kat:'≈Ωivotinje',  boja:'#10B981' },
  { e:'ü¶Å', r:'LAV',     s:'L ¬∑ A ¬∑ V',      kat:'≈Ωivotinje',  boja:'#F97316' },
  { e:'üêò', r:'SLON',    s:'S ¬∑ LON',        kat:'≈Ωivotinje',  boja:'#6B7280' },
  { e:'üêß', r:'PINGVIN', s:'PING ¬∑ VIN',     kat:'≈Ωivotinje',  boja:'#3B82F6' },
  { e:'ü¶ä', r:'LISICA',  s:'LI ¬∑ SI ¬∑ CA',   kat:'≈Ωivotinje',  boja:'#F97316' },
  // Priroda i hrana
  { e:'üå∏', r:'CVIJET',  s:'CVI ¬∑ JET',      kat:'Priroda',    boja:'#EC4899' },
  { e:'üçé', r:'JABUKA',  s:'JA ¬∑ BU ¬∑ KA',   kat:'Voƒáe',       boja:'#EF4444' },
  { e:'üçå', r:'BANANA',  s:'BA ¬∑ NA ¬∑ NA',   kat:'Voƒáe',       boja:'#FBBF24' },
  { e:'üçì', r:'JAGODA',  s:'JA ¬∑ GO ¬∑ DA',   kat:'Voƒáe',       boja:'#EF4444' },
  { e:'‚òÄÔ∏è', r:'SUNCE',   s:'SUN ¬∑ CE',       kat:'Priroda',    boja:'#FBBF24' },
  { e:'üåô', r:'MJESEC',  s:'MJE ¬∑ SEC',      kat:'Priroda',    boja:'#A855F7' },
  // Prijevoz
  { e:'üöó', r:'AUTO',    s:'AU ¬∑ TO',        kat:'Prijevoz',   boja:'#EF4444' },
  { e:'üö¢', r:'BROD',    s:'B ¬∑ ROD',        kat:'Prijevoz',   boja:'#3B82F6' },
  { e:'‚úàÔ∏è', r:'AVION',   s:'A ¬∑ VI ¬∑ ON',    kat:'Prijevoz',   boja:'#06B6D4' },
  // Obitelj i tijelo
  { e:'üë∂', r:'BEBA',    s:'BE ¬∑ BA',        kat:'Obitelj',    boja:'#EC4899' },
  { e:'üè†', r:'KUƒÜA',    s:'KU ¬∑ ƒÜA',       kat:'Dom',        boja:'#84CC16' },
  { e:'‚öΩ', r:'LOPTA',   s:'LOP ¬∑ TA',       kat:'Igraƒçke',    boja:'#10B981' },
];

let govorIdx=0; // which word we're on (0-19)
let govorSpeaking=false;

function startGovor(lvl){
  LVL=lvl;
  govorIdx=0;
  govorSpeaking=false;
  document.getElementById('govor-lvl-lbl').textContent=`${lvl}/20`;
  document.getElementById('govor-prog-bar').style.width=((lvl-1)/20*100)+'%';
  renderGovorWord();
  showScreen('screen-govor');
  // Auto-play the word after a short delay
  setTimeout(govorListen, 600);
}

function renderGovorWord(){
  const w=GOVOR_RIJECI[govorIdx];
  const card=document.getElementById('govor-card');

  // Animate card swap
  card.style.opacity='0';
  card.style.transform='scale(.95)';
  setTimeout(()=>{
    document.getElementById('govor-emoji').textContent=w.e;
    document.getElementById('govor-word').textContent=w.r;
    document.getElementById('govor-word').style.color=w.boja;
    document.getElementById('govor-syllables').textContent=w.s;
    document.getElementById('govor-category').textContent=w.kat;

    // Card bg glow per color
    card.style.boxShadow=`0 20px 60px rgba(0,0,0,.5), 0 0 80px ${w.boja}22`;
    card.style.opacity='1';
    card.style.transform='scale(1)';

    // Nav state
    document.getElementById('govor-prev').disabled=(govorIdx===0);
    document.getElementById('govor-next').disabled=(govorIdx===GOVOR_RIJECI.length-1);
    document.getElementById('govor-counter').textContent=`${govorIdx+1} / ${GOVOR_RIJECI.length}`;
  },180);

  card.style.transition='opacity .18s ease, transform .18s ease';
}

function govorListen(){
  if(govorSpeaking) return;
  const w=GOVOR_RIJECI[govorIdx];
  govorSpeaking=true;

  // Show sound wave animation on button
  const btn=document.getElementById('govor-listen-btn');
  const origHTML=btn.innerHTML;
  btn.innerHTML=`<div class="govor-listen-anim">
    <div class="govor-bar"></div><div class="govor-bar"></div>
    <div class="govor-bar"></div><div class="govor-bar"></div>
    <div class="govor-bar"></div>
  </div>`;

  // Animate emoji
  const em=document.getElementById('govor-emoji');
  em.style.animation='none';
  em.offsetHeight; // reflow
  em.style.animation='emojiPop .4s cubic-bezier(.34,1.56,.64,1)';

  speak(w.r.toLowerCase(), ()=>{
    govorSpeaking=false;
    btn.innerHTML=origHTML;
  });

  // Fallback restore if TTS fails
  setTimeout(()=>{ govorSpeaking=false; btn.innerHTML=origHTML; },3000);
}

// ‚îÄ‚îÄ Hold-to-record ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Single global SR instance ‚Äî avoids permission prompt every time
let govorRec=null, govorRecording=false;

function govorInitRec(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return false;
  if(govorRec) return true; // already exists

  govorRec=new SR();
  govorRec.lang='hr-HR';
  govorRec.continuous=false;
  govorRec.interimResults=false;
  govorRec.maxAlternatives=6;

  govorRec.onresult=(ev)=>{
    const said=Array.from(ev.results[0]).map(r=>r.transcript.toUpperCase().trim());
    govorHandleResult(said);
  };
  govorRec.onerror=(ev)=>{
    if(ev.error==='not-allowed') govorPermError();
    else govorResetBtn();
  };
  govorRec.onend=()=>{ if(govorRecording) govorResetBtn(); };
  return true;
}

function govorBtnDown(e){
  e.preventDefault();
  if(govorRecording) return;

  if(!govorInitRec()){ govorNoMic(); return; }

  govorRecording=true;
  const btn=document.getElementById('govor-speak-btn');
  btn.innerHTML=`<div class="govor-mic-pulse">üé§</div><span style="font-size:.8rem;margin-top:2px;">Govori...</span>`;
  btn.style.background='linear-gradient(135deg,#EF4444,#B91C1C)';
  btn.style.transform='scale(.93)';

  try{ govorRec.start(); }
  catch(e){ govorResetBtn(); }
}

function govorBtnUp(e){
  e.preventDefault();
  if(!govorRecording) return;
  try{ govorRec.stop(); }catch(e){}
  govorRecording=false;
  // If no result in 800ms ‚Üí nisam ƒçuo
  setTimeout(()=>{
    const btn=document.getElementById('govor-speak-btn');
    if(btn && btn.innerHTML.includes('Govori')) govorResetBtn();
  }, 800);
}

function govorHandleResult(said){
  govorRecording=false;
  const w=GOVOR_RIJECI[govorIdx];
  const btn=document.getElementById('govor-speak-btn');
  const target=w.r.toUpperCase().replace(/\s/g,'');
  const correct=said.some(s=>{
    const sc=s.replace(/\s/g,'');
    return sc===target
      || sc.includes(target)
      || target.includes(sc)
      || (sc.length>=3 && target.startsWith(sc.slice(0,3)))
      || (target.length>=3 && sc.startsWith(target.slice(0,3)));
  });

  if(correct){
    btn.innerHTML=`<span class="govor-btn-icon">‚≠ê</span>Bravo!`;
    btn.style.background='linear-gradient(135deg,#10B981,#06B6D4)';
    btn.style.transform='';
    playCorrect();
    speak('Bravo!');
    const em=document.getElementById('govor-emoji');
    em.style.animation='none'; em.offsetHeight;
    em.style.animation='emojiPop .5s cubic-bezier(.34,1.56,.64,1)';
    setTimeout(()=>{
      govorResetBtn();
      if(govorIdx<GOVOR_RIJECI.length-1) govorNav(1);
      else govorFinish();
    }, 1600);
  } else {
    btn.innerHTML=`<span class="govor-btn-icon">üîÑ</span>Poku≈°aj opet!`;
    btn.style.background='linear-gradient(135deg,#F97316,#FBBF24)';
    btn.style.transform='';
    playWrong();
    setTimeout(()=>speak(w.r.toLowerCase()),300);
    setTimeout(govorResetBtn, 2000);
  }
}

function govorResetBtn(){
  govorRecording=false;
  // Don't destroy govorRec ‚Äî keep it alive to avoid re-permission prompt
  const btn=document.getElementById('govor-speak-btn');
  if(!btn) return;
  btn.innerHTML=`<span class="govor-btn-icon">üé§</span><span>Dr≈æi i govori</span>`;
  btn.style.background='';
  btn.style.transform='';
}

function govorNoMic(){
  govorRecording=false;
  // Fallback ‚Äî just give bravo
  const btn=document.getElementById('govor-speak-btn');
  btn.innerHTML=`<span class="govor-btn-icon">‚≠ê</span>Bravo!`;
  btn.style.background='linear-gradient(135deg,#10B981,#06B6D4)';
  btn.style.transform='';
  playCorrect(); speak('Bravo!');
  setTimeout(()=>{ govorResetBtn(); govorNav(1); }, 1500);
}

function govorPermError(){
  govorRecording=false;
  const btn=document.getElementById('govor-speak-btn');
  btn.innerHTML=`<span class="govor-btn-icon">üö´</span>Dozvoli mikrofon`;
  btn.style.background='linear-gradient(135deg,#EF4444,#991B1B)';
  btn.style.transform='';
  setTimeout(govorResetBtn, 2500);
}

function govorSpeak(){} // unused ‚Äî kept for safety

function govorNav(dir){
  playClick();
  govorIdx=Math.max(0,Math.min(GOVOR_RIJECI.length-1, govorIdx+dir));
  renderGovorWord();
  setTimeout(govorListen, 400);

  // Mark this level word as seen ‚Äî unlock next level
  if(dir===1){
    completed['govor'].add(LVL);
    if(govorIdx===GOVOR_RIJECI.length-1){
      setTimeout(govorFinish, 800);
    }
  }
}

function govorFinish(){
  completed['govor'].add(LVL);
  confetti();
  setTimeout(playWin,200);
  setTimeout(()=>speak('Bravo! Super si nauƒçio!'),600);
  setTimeout(()=>{
    document.getElementById('res-emoji').textContent='üó£Ô∏è';
    document.getElementById('res-title').textContent='Odliƒçno! Sve si nauƒçio!';
    document.getElementById('res-sub').textContent='Nastavi vje≈æbati!';
    document.getElementById('res-stars').innerHTML='‚≠ê‚≠ê‚≠ê';
    document.getElementById('next-lvl-btn').style.display=LVL<20?'':'none';
    document.getElementById('result-overlay').classList.add('show');
  },1400);
}

// BOOT
ss&&ss.getVoices();
ss&&ss.addEventListener('voiceschanged',()=>{});
initDots();

// Jingle na prvi klik (browser zahtijeva user interaction za audio)
let jinglePlayed=false;
document.addEventListener('click',()=>{
  if(!jinglePlayed){ jinglePlayed=true; setTimeout(playJingle,80); }
},{once:true});
</script>
</body>
</html>
